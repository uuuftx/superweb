{% extends "base.html" %}

{% block content %}
<style>
/* å·¥ä½œæµåˆ—è¡¨é«˜çº§æ ·å¼ */

/* å·¥å…·æ  */
.workflow-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    gap: 15px;
    flex-wrap: wrap;
}

.toolbar-left, .toolbar-right {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

/* æœç´¢æ¡† */
.search-box {
    position: relative;
    width: 300px;
}

.search-box input {
    width: 100%;
    padding: 10px 16px 10px 40px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.2s;
}

.search-box input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-box::before {
    content: 'ğŸ”';
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    opacity: 0.5;
}

/* è¿‡æ»¤å™¨ */
.filter-group {
    display: flex;
    gap: 8px;
    align-items: center;
}

.filter-select {
    padding: 8px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
}

.filter-select:hover {
    border-color: #667eea;
}

/* æ‰¹é‡æ“ä½œæ  */
.bulk-actions {
    display: none;
    padding: 12px 16px;
    background: #f0f9ff;
    border: 2px solid #0ea5e9;
    border-radius: 8px;
    margin-bottom: 15px;
    animation: slideDown 0.2s ease-out;
}

.bulk-actions.active {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.bulk-info {
    font-weight: 600;
    color: #0369a1;
}

.bulk-buttons {
    display: flex;
    gap: 8px;
}

/* è¡¨æ ¼æ ·å¼å¢å¼º */
#workflows-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

#workflows-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

#workflows-table th {
    padding: 16px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#workflows-table th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
}

#workflows-table th.sortable:hover {
    background: rgba(255,255,255,0.1);
}

#workflows-table th.sortable::after {
    content: 'â†•';
    position: absolute;
    right: 8px;
    opacity: 0.5;
    font-size: 12px;
}

#workflows-table th.sortable.asc::after {
    content: 'â†‘';
    opacity: 1;
}

#workflows-table th.sortable.desc::after {
    content: 'â†“';
    opacity: 1;
}

#workflows-table td {
    padding: 14px 16px;
    border-bottom: 1px solid #f0f0f0;
    vertical-align: middle;
}

#workflows-table tbody tr {
    transition: all 0.2s;
}

#workflows-table tbody tr:hover {
    background: #f7fafc;
    transform: scale(1.002);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

#workflows-table tbody tr.selected {
    background: #edf2f7;
    border-left: 3px solid #667eea;
}

/* å¤é€‰æ¡† */
.row-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #667eea;
}

/* å·¥ä½œæµåç§°å¢å¼º */
.workflow-name-cell {
    display: flex;
    align-items: center;
    gap: 10px;
}

.workflow-name-wrapper {
    flex: 1;
}

.workflow-name {
    font-weight: 600;
    color: #2d3748;
    font-size: 14px;
    margin-bottom: 2px;
}

.workflow-id-badge {
    font-size: 11px;
    color: #a0aec0;
    background: #f7fafc;
    padding: 2px 6px;
    border-radius: 4px;
}

.workflow-meta {
    display: flex;
    gap: 8px;
    font-size: 12px;
    color: #718096;
    margin-top: 4px;
}

.workflow-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* çŠ¶æ€å¾½ç« å¢å¼º */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s;
}

.status-badge::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-badge.enabled {
    background: #d1fae5;
    color: #065f46;
}

.status-badge.enabled::before {
    background: #10b981;
    box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
}

.status-badge.disabled {
    background: #f3f4f6;
    color: #6b7280;
}

.status-badge.disabled::before {
    background: #9ca3af;
}

/* æ“ä½œæŒ‰é’®ç»„ */
.action-buttons {
    display: flex;
    gap: 6px;
    align-items: center;
}

.action-btn {
    padding: 6px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    background: white;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    text-decoration: none;
    color: #4a5568;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.action-btn.edit:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.action-btn.logs:hover {
    background: #0ea5e9;
    color: white;
    border-color: #0ea5e9;
}

.action-btn.delete:hover {
    background: #ef4444;
    color: white;
    border-color: #ef4444;
}

.action-btn.toggle {
    min-width: 60px;
}

.action-btn.toggle.active {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

/* ç©ºçŠ¶æ€å¢å¼º */
.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state-title {
    font-size: 18px;
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 8px;
}

.empty-state-desc {
    font-size: 14px;
    color: #718096;
    margin-bottom: 20px;
}

/* å¿«æ·é”®æç¤º */
.shortcut-hint {
    font-size: 11px;
    color: #a0aec0;
    background: #f7fafc;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 4px;
}

/* ç»Ÿè®¡å¡ç‰‡ */
.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    padding: 16px;
    border-radius: 10px;
    border-left: 4px solid #667eea;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    transition: all 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.stat-card.total { border-left-color: #667eea; }
.stat-card.enabled { border-left-color: #10b981; }
.stat-card.disabled { border-left-color: #ef4444; }

.stat-label {
    font-size: 12px;
    color: #718096;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #2d3748;
}

/* å¿«é€Ÿç¼–è¾‘ä¸‹æ‹‰ */
.quick-edit-dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-menu {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    margin-top: 4px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 180px;
    z-index: 100;
    animation: fadeIn 0.15s ease-out;
}

.dropdown-menu.show {
    display: block;
}

.dropdown-item {
    padding: 10px 16px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
}

.dropdown-item:hover {
    background: #f7fafc;
}

.dropdown-item.danger {
    color: #ef4444;
}

.dropdown-item.danger:hover {
    background: #fee2e2;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-cards">
    <div class="stat-card total">
        <div class="stat-label">æ€»å·¥ä½œæµ</div>
        <div class="stat-value" id="stat-total">0</div>
    </div>
    <div class="stat-card enabled">
        <div class="stat-label">å·²å¯ç”¨</div>
        <div class="stat-value" id="stat-enabled">0</div>
    </div>
    <div class="stat-card disabled">
        <div class="stat-label">å·²ç¦ç”¨</div>
        <div class="stat-value" id="stat-disabled">0</div>
    </div>
</div>

<!-- å·¥å…·æ  -->
<div class="card">
    <div class="workflow-toolbar">
        <div class="toolbar-left">
            <button class="btn btn-primary" onclick="showCreateModal()">
                + æ–°å»ºå·¥ä½œæµ
            </button>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="æœç´¢å·¥ä½œæµåç§°..." oninput="filterWorkflows()">
            </div>
        </div>
        <div class="toolbar-right">
            <div class="filter-group">
                <select id="status-filter" class="filter-select" onchange="filterWorkflows()">
                    <option value="all">æ‰€æœ‰çŠ¶æ€</option>
                    <option value="enabled">å·²å¯ç”¨</option>
                    <option value="disabled">å·²ç¦ç”¨</option>
                </select>
                <select id="sort-select" class="filter-select" onchange="sortWorkflows()">
                    <option value="updated_desc">æœ€æ–°æ›´æ–°</option>
                    <option value="name_asc">åç§° (A-Z)</option>
                    <option value="name_desc">åç§° (Z-A)</option>
                    <option value="created_asc">æœ€æ—©åˆ›å»º</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- æ‰¹é‡æ“ä½œæ  -->
<div class="bulk-actions" id="bulk-actions">
    <div class="bulk-info">
        å·²é€‰æ‹© <strong id="selected-count">0</strong> é¡¹
    </div>
    <div class="bulk-buttons">
        <button class="btn btn-sm" onclick="bulkEnable()">æ‰¹é‡å¯ç”¨</button>
        <button class="btn btn-sm" onclick="bulkDisable()">æ‰¹é‡ç¦ç”¨</button>
        <button class="btn btn-sm btn-danger" onclick="bulkDelete()">æ‰¹é‡åˆ é™¤</button>
        <button class="btn btn-sm" onclick="clearSelection()">å–æ¶ˆé€‰æ‹©</button>
    </div>
</div>

<!-- å·¥ä½œæµè¡¨æ ¼ -->
<div class="card" style="padding: 0;">
    <table id="workflows-table">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="select-all-checkbox" class="row-checkbox" onchange="toggleSelectAll()">
                </th>
                <th class="sortable" onclick="sortBy('name')">å·¥ä½œæµåç§°</th>
                <th>æè¿°</th>
                <th class="sortable" onclick="sortBy('status')">çŠ¶æ€</th>
                <th style="width: 280px;">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="workflows-tbody">
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: #a0aec0;">
                    åŠ è½½ä¸­...
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- åˆ†é¡µæ§ä»¶ -->
<div id="pagination" class="pagination-container" style="display: none;">
    <div class="pagination-info">
        <span id="pagination-info-text">ç¬¬ 1 / 1 é¡µï¼Œå…± 0 æ¡</span>
    </div>
    <div class="pagination-controls">
        <button id="prev-page-btn" class="page-btn" onclick="changePage(-1)" disabled>
            â† ä¸Šä¸€é¡µ
        </button>
        <div id="page-numbers" class="page-numbers"></div>
        <button id="next-page-btn" class="page-btn" onclick="changePage(1)">
            ä¸‹ä¸€é¡µâ†’
        </button>
        <select id="page-size-select" class="page-size-select" onchange="changePageSize()">
            <option value="10">10æ¡/é¡µ</option>
            <option value="20" selected>20æ¡/é¡µ</option>
            <option value="50">50æ¡/é¡µ</option>
            <option value="100">100æ¡/é¡µ</option>
        </select>
    </div>
</div>

<!-- åˆ›å»ºå·¥ä½œæµæ¨¡æ€æ¡† -->
<div id="workflow-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>âœ¨ æ–°å»ºå·¥ä½œæµ</h3>
            <button class="close" onclick="closeModal()">&times;</button>
        </div>
        <form id="workflow-form">
            <div class="modal-body">
                <div class="form-group">
                    <label>å·¥ä½œæµåç§°</label>
                    <input type="text" id="workflow-name" placeholder="ä¾‹å¦‚: ç”¨æˆ·æ³¨å†Œæµç¨‹" required>
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="workflow-description" rows="3" placeholder="æè¿°è¿™ä¸ªå·¥ä½œæµçš„ä½œç”¨..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">åˆ›å»ºå·¥ä½œæµ</button>
            </div>
        </form>
    </div>
</div>

<!-- ç¡®è®¤å¯¹è¯æ¡† -->
<div class="confirm-dialog" id="confirm-dialog">
    <div class="confirm-box">
        <div class="confirm-header">
            <div class="confirm-icon">âš ï¸</div>
            <div class="confirm-title" id="confirm-title">ç¡®è®¤æ“ä½œ</div>
            <div class="confirm-message" id="confirm-message">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
        </div>
        <div class="confirm-footer">
            <button class="confirm-btn confirm-btn-cancel" id="confirm-cancel">å–æ¶ˆ</button>
            <button class="confirm-btn confirm-btn-confirm" id="confirm-ok">ç¡®è®¤</button>
        </div>
    </div>
</div>

<script>
let workflows = [];
let filteredWorkflows = [];
let currentPage = 1;
let pageSize = 20;
let totalPages = 1;
let totalItems = 0;
let selectedIds = new Set();
let currentSort = { field: 'updated', order: 'desc' };

// åŠ è½½å·¥ä½œæµ
async function loadWorkflows() {
    try {
        const data = await api('/api/admin/workflows');
        workflows = data.items;
        applyFiltersAndSort();
        updateStats();
    } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        showToast('åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½å·¥ä½œæµåˆ—è¡¨', 'error');
    }
}

// æ›´æ–°ç»Ÿè®¡
function updateStats() {
    const total = workflows.length;
    const enabled = workflows.filter(w => w.enabled).length;
    const disabled = total - enabled;

    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-enabled').textContent = enabled;
    document.getElementById('stat-disabled').textContent = disabled;
}

// åº”ç”¨è¿‡æ»¤å’Œæ’åº
function applyFiltersAndSort() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;

    // è¿‡æ»¤
    filteredWorkflows = workflows.filter(w => {
        const matchesSearch = w.name.toLowerCase().includes(searchTerm) ||
                            (w.description && w.description.toLowerCase().includes(searchTerm));
        const matchesStatus = statusFilter === 'all' ||
                              (statusFilter === 'enabled' && w.enabled) ||
                              (statusFilter === 'disabled' && !w.enabled);
        return matchesSearch && matchesStatus;
    });

    // æ’åº
    filteredWorkflows.sort((a, b) => {
        const field = currentSort.field;
        const order = currentSort.order === 'asc' ? 1 : -1;

        if (field === 'name') {
            return a.name.localeCompare(b.name) * order;
        } else if (field === 'status') {
            return (a.enabled === b.enabled ? 0 : (a.enabled ? 1 : -1)) * order;
        } else {
            // é»˜è®¤æŒ‰IDæ’åºï¼ˆä½œä¸ºåˆ›å»ºæ—¶é—´çš„ä»£ç†ï¼‰
            return (b.id - a.id) * order;
        }
    });

    totalItems = filteredWorkflows.length;
    totalPages = Math.ceil(totalItems / pageSize) || 1;
    currentPage = 1;

    renderWorkflows();
    updatePaginationInfo();
}

// è¿‡æ»¤å·¥ä½œæµ
function filterWorkflows() {
    applyFiltersAndSort();
}

// æ’åºå·¥ä½œæµ
function sortWorkflows() {
    const select = document.getElementById('sort-select');
    const value = select.value;
    const [field, order] = value.split('_');
    currentSort = { field, order };
    applyFiltersAndSort();
}

// æŒ‰åˆ—æ’åº
function sortBy(field) {
    if (currentSort.field === field) {
        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.order = 'asc';
    }

    // æ›´æ–°ä¸‹æ‹‰æ¡†
    const select = document.getElementById('sort-select');
    // ç®€åŒ–å¤„ç†ï¼Œä¸ç²¾ç¡®åŒ¹é…
    select.value = field + '_' + currentSort.order;

    applyFiltersAndSort();
}

// æ¸²æŸ“å·¥ä½œæµ
function renderWorkflows() {
    const tbody = document.getElementById('workflows-tbody');

    if (filteredWorkflows.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <div class="empty-state-title">æš‚æ— å·¥ä½œæµ</div>
                        <div class="empty-state-desc">
                            ${workflows.length === 0 ?
                                'è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•å·¥ä½œæµã€‚ç‚¹å‡»"æ–°å»ºå·¥ä½œæµ"å¼€å§‹åˆ›å»ºå§ï¼' :
                                'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å·¥ä½œæµï¼Œè¯·å°è¯•å…¶ä»–æœç´¢æ¡ä»¶ã€‚'}
                        </div>
                        ${workflows.length === 0 ?
                            '<a href="/ui/workflow-editor" class="btn btn-primary">åˆ›å»ºç¬¬ä¸€ä¸ªå·¥ä½œæµ</a>' :
                            '<button class="btn" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>'}
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    // åˆ†é¡µ
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, totalItems);
    const pageWorkflows = filteredWorkflows.slice(startIndex, endIndex);

    tbody.innerHTML = pageWorkflows.map(w => `
        <tr class="${selectedIds.has(w.id) ? 'selected' : ''}" data-id="${w.id}">
            <td>
                <input type="checkbox" class="row-checkbox workflow-checkbox"
                       data-id="${w.id}"
                       ${selectedIds.has(w.id) ? 'checked' : ''}
                       onchange="toggleSelect(${w.id})">
            </td>
            <td>
                <div class="workflow-name-cell">
                    <div class="workflow-name-wrapper">
                        <div class="workflow-name">${w.name}</div>
                        <div class="workflow-id-badge">ID: ${w.id}</div>
                        <div class="workflow-meta">
                            <span class="workflow-meta-item">ğŸ“ èŠ‚ç‚¹: ${w.node_count || '-'}</span>
                        </div>
                    </div>
                    <button onclick="copyWorkflowName('${w.name}')"
                            class="copy-btn"
                            title="å¤åˆ¶æµç¨‹å"
                            data-name="${w.name}">
                        ğŸ“‹
                    </button>
                </div>
            </td>
            <td style="color: #718096; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${w.description || '-'}
            </td>
            <td>
                <span class="status-badge ${w.enabled ? 'enabled' : 'disabled'}">
                    ${w.enabled ? 'âœ“ å·²å¯ç”¨' : 'âœ— å·²ç¦ç”¨'}
                </span>
            </td>
            <td>
                <div class="action-buttons">
                    <a href="/ui/workflow-editor?workflow=${w.id}"
                       class="action-btn edit"
                       title="ç¼–è¾‘å·¥ä½œæµ">
                        âš¡ ç¼–è¾‘
                    </a>
                    <a href="/ui/workflow-logs?workflow_id=${w.id}"
                       class="action-btn logs"
                       title="æŸ¥çœ‹æ—¥å¿—">
                        ğŸ“‹ æ—¥å¿—
                    </a>
                    <button class="action-btn toggle ${w.enabled ? 'active' : ''}"
                            onclick="toggleWorkflow(${w.id}, ${!w.enabled})"
                            title="${w.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}">
                        ${w.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                    </button>
                    <button class="action-btn delete"
                            onclick="deleteWorkflow(${w.id})"
                            title="åˆ é™¤">
                        ğŸ—‘ï¸
                    </button>
                </div>
            </td>
        </tr>
    `).join('');

    // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
    updateSelectAllCheckbox();
}

// åˆ‡æ¢é€‰æ‹©
function toggleSelect(id) {
    if (selectedIds.has(id)) {
        selectedIds.delete(id);
    } else {
        selectedIds.add(id);
    }
    updateBulkActions();
    renderWorkflows(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
}

// å…¨é€‰/å–æ¶ˆå…¨é€‰
function toggleSelectAll() {
    const checkbox = document.getElementById('select-all-checkbox');
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, totalItems);
    const pageWorkflows = filteredWorkflows.slice(startIndex, endIndex);

    if (checkbox.checked) {
        pageWorkflows.forEach(w => selectedIds.add(w.id));
    } else {
        pageWorkflows.forEach(w => selectedIds.delete(w.id));
    }

    updateBulkActions();
    renderWorkflows();
}

// æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
function updateSelectAllCheckbox() {
    const checkbox = document.getElementById('select-all-checkbox');
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, totalItems);
    const pageWorkflows = filteredWorkflows.slice(startIndex, endIndex);

    if (pageWorkflows.length === 0) {
        checkbox.checked = false;
        checkbox.indeterminate = false;
        return;
    }

    const allSelected = pageWorkflows.every(w => selectedIds.has(w.id));
    const someSelected = pageWorkflows.some(w => selectedIds.has(w.id));

    checkbox.checked = allSelected;
    checkbox.indeterminate = !allSelected && someSelected;
}

// æ›´æ–°æ‰¹é‡æ“ä½œæ 
function updateBulkActions() {
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');

    selectedCount.textContent = selectedIds.size;

    if (selectedIds.size > 0) {
        bulkActions.classList.add('active');
    } else {
        bulkActions.classList.remove('active');
    }
}

// æ¸…é™¤é€‰æ‹©
function clearSelection() {
    selectedIds.clear();
    updateBulkActions();
    renderWorkflows();
}

// æ‰¹é‡å¯ç”¨
async function bulkEnable() {
    const ids = Array.from(selectedIds);
    try {
        for (const id of ids) {
            await api(`/api/admin/workflows/${id}`, {
                method: 'PATCH',
                body: JSON.stringify({ enabled: true })
            });
        }
        showToast('æˆåŠŸ', `å·²å¯ç”¨ ${ids.length} ä¸ªå·¥ä½œæµ`, 'success');
        clearSelection();
        await loadWorkflows();
    } catch (error) {
        showToast('å¤±è´¥', error.message, 'error');
    }
}

// æ‰¹é‡ç¦ç”¨
async function bulkDisable() {
    const ids = Array.from(selectedIds);
    try {
        for (const id of ids) {
            await api(`/api/admin/workflows/${id}`, {
                method: 'PATCH',
                body: JSON.stringify({ enabled: false })
            });
        }
        showToast('æˆåŠŸ', `å·²ç¦ç”¨ ${ids.length} ä¸ªå·¥ä½œæµ`, 'success');
        clearSelection();
        await loadWorkflows();
    } catch (error) {
        showToast('å¤±è´¥', error.message, 'error');
    }
}

// æ‰¹é‡åˆ é™¤
async function bulkDelete() {
    const ids = Array.from(selectedIds);

    const confirmed = await showConfirm(
        'ç¡®è®¤æ‰¹é‡åˆ é™¤',
        `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} ä¸ªå·¥ä½œæµå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
        {
            icon: 'ğŸ—‘ï¸',
            confirmText: 'ç¡®è®¤åˆ é™¤',
            cancelText: 'å–æ¶ˆ'
        }
    );

    if (!confirmed) return;

    try {
        for (const id of ids) {
            await api(`/api/admin/workflows/${id}`, {
                method: 'DELETE'
            });
        }
        showToast('æˆåŠŸ', `å·²åˆ é™¤ ${ids.length} ä¸ªå·¥ä½œæµ`, 'success');
        clearSelection();
        await loadWorkflows();
    } catch (error) {
        showToast('å¤±è´¥', error.message, 'error');
    }
}

// åˆ‡æ¢å·¥ä½œæµçŠ¶æ€
async function toggleWorkflow(id, enabled) {
    try {
        await api(`/api/admin/workflows/${id}`, {
            method: 'PATCH',
            body: JSON.stringify({ enabled })
        });
        showToast('æˆåŠŸ', `å·¥ä½œæµå·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'success');
        await loadWorkflows();
    } catch (error) {
        showToast('å¤±è´¥', error.message, 'error');
    }
}

// æ¸…é™¤ç­›é€‰
function clearFilters() {
    document.getElementById('search-input').value = '';
    document.getElementById('status-filter').value = 'all';
    applyFiltersAndSort();
}

// æ›´æ–°åˆ†é¡µä¿¡æ¯
function updatePaginationInfo() {
    const pagination = document.getElementById('pagination');
    const infoText = document.getElementById('pagination-info-text');
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');

    if (totalItems <= pageSize) {
        pagination.style.display = 'none';
        return;
    }

    pagination.style.display = 'flex';
    infoText.textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µï¼Œå…± ${totalItems} æ¡`;

    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;

    // ç”Ÿæˆé¡µç 
    const pageNumbers = document.getElementById('page-numbers');
    pageNumbers.innerHTML = '';

    const maxPages = 7;

    if (totalPages <= maxPages) {
        for (let i = 1; i <= totalPages; i++) {
            pageNumbers.appendChild(createPageButton(i));
        }
    } else {
        if (currentPage <= 4) {
            for (let i = 1; i <= 5; i++) {
                pageNumbers.appendChild(createPageButton(i));
            }
            pageNumbers.appendChild(createEllipsis());
            pageNumbers.appendChild(createPageButton(totalPages));
        } else if (currentPage >= totalPages - 3) {
            pageNumbers.appendChild(createPageButton(1));
            pageNumbers.appendChild(createEllipsis());
            for (let i = totalPages - 4; i <= totalPages; i++) {
                pageNumbers.appendChild(createPageButton(i));
            }
        } else {
            pageNumbers.appendChild(createPageButton(1));
            pageNumbers.appendChild(createEllipsis());
            for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                pageNumbers.appendChild(createPageButton(i));
            }
            pageNumbers.appendChild(createEllipsis());
            pageNumbers.appendChild(createPageButton(totalPages));
        }
    }
}

function createPageButton(page) {
    const btn = document.createElement('button');
    btn.className = 'page-number' + (page === currentPage ? ' active' : '');
    btn.textContent = page;
    btn.onclick = () => goToPage(page);
    return btn;
}

function createEllipsis() {
    const span = document.createElement('span');
    span.textContent = '...';
    span.style.cssText = 'padding: 0 4px; color: #a0aec0;';
    return span;
}

function changePage(delta) {
    const newPage = currentPage + delta;
    if (newPage >= 1 && newPage <= totalPages) {
        goToPage(newPage);
    }
}

function goToPage(page) {
    currentPage = page;
    renderWorkflows();
    updatePaginationInfo();
    document.getElementById('workflows-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function changePageSize() {
    const select = document.getElementById('page-size-select');
    pageSize = parseInt(select.value);
    totalPages = Math.ceil(totalItems / pageSize) || 1;
    currentPage = 1;
    renderWorkflows();
    updatePaginationInfo();
}

// æ˜¾ç¤ºåˆ›å»ºæ¨¡æ€æ¡†
function showCreateModal() {
    document.getElementById('workflow-form').reset();
    document.getElementById('workflow-modal').classList.add('active');
}

// å…³é—­æ¨¡æ€æ¡†
function closeModal() {
    document.getElementById('workflow-modal').classList.remove('active');
}

// è¡¨å•æäº¤
document.getElementById('workflow-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        name: document.getElementById('workflow-name').value,
        description: document.getElementById('workflow-description').value,
    };

    try {
        const result = await api('/api/admin/workflows', {
            method: 'POST',
            body: JSON.stringify(data)
        });
        closeModal();
        showToast('åˆ›å»ºæˆåŠŸ', `å·¥ä½œæµ "${data.name}" å·²åˆ›å»º`, 'success');
        await loadWorkflows();
        window.location.href = `/ui/workflow-editor?workflow=${result.id}`;
    } catch (error) {
        showToast('åˆ›å»ºå¤±è´¥', error.message, 'error');
    }
});

// åˆ é™¤å·¥ä½œæµ
async function deleteWorkflow(id) {
    const workflow = workflows.find(w => w.id === id);
    const confirmed = await showConfirm(
        'ç¡®è®¤åˆ é™¤å·¥ä½œæµ',
        `ç¡®å®šè¦åˆ é™¤å·¥ä½œæµ "${workflow?.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
        {
            icon: 'ğŸ—‘ï¸',
            confirmText: 'ç¡®è®¤åˆ é™¤',
            cancelText: 'å–æ¶ˆ'
        }
    );

    if (!confirmed) return;

    try {
        await api(`/api/admin/workflows/${id}`, {
            method: 'DELETE'
        });
        showToast('åˆ é™¤æˆåŠŸ', `å·¥ä½œæµ "${workflow?.name}" å·²åˆ é™¤`, 'success');
        await loadWorkflows();
    } catch (error) {
        showToast('åˆ é™¤å¤±è´¥', error.message, 'error');
    }
}

// å¤åˆ¶å·¥ä½œæµåç§°
async function copyWorkflowName(name) {
    try {
        await navigator.clipboard.writeText(name);
        showToast('å¤åˆ¶æˆåŠŸ', `æµç¨‹å "${name}" å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success', 2000);

        const btn = document.querySelector(`.copy-btn[data-name="${name}"]`);
        if (btn) {
            const originalText = btn.textContent;
            btn.textContent = 'âœ…';
            btn.style.background = '#10b981';
            btn.style.color = 'white';
            btn.style.transform = 'scale(1.2)';

            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
                btn.style.color = '';
                btn.style.transform = '';
            }, 1000);
        }
    } catch (error) {
        const textArea = document.createElement('textarea');
        textArea.value = name;
        textArea.style.cssText = 'position: fixed; top: -9999px; left: -9999px;';
        document.body.appendChild(textArea);
        textArea.select();

        try {
            document.execCommand('copy');
            showToast('å¤åˆ¶æˆåŠŸ', `æµç¨‹å "${name}" å·²å¤åˆ¶`, 'success', 2000);
        } catch (err) {
            showToast('å¤åˆ¶å¤±è´¥', 'æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿', 'error', 3000);
        }

        document.body.removeChild(textArea);
    }
}

// ç¡®è®¤å¯¹è¯æ¡†
function showConfirm(title, message, options = {}) {
    const dialog = document.getElementById('confirm-dialog');
    const titleEl = document.getElementById('confirm-title');
    const messageEl = document.getElementById('confirm-message');
    const cancelBtn = document.getElementById('confirm-cancel');
    const okBtn = document.getElementById('confirm-ok');

    titleEl.textContent = title || 'ç¡®è®¤æ“ä½œ';
    messageEl.textContent = message || 'ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ';

    cancelBtn.textContent = options.cancelText || 'å–æ¶ˆ';
    okBtn.textContent = options.confirmText || 'ç¡®è®¤';

    const iconEl = dialog.querySelector('.confirm-icon');
    iconEl.textContent = options.icon || 'âš ï¸';

    dialog.classList.add('active');

    return new Promise((resolve) => {
        const cleanup = () => {
            dialog.classList.remove('active');
            cancelBtn.onclick = null;
            okBtn.onclick = null;
        };

        cancelBtn.onclick = () => {
            cleanup();
            resolve(false);
        };

        okBtn.onclick = () => {
            cleanup();
            resolve(true);
        };

        dialog.onclick = (e) => {
            if (e.target === dialog) {
                cleanup();
                resolve(false);
            }
        };
    });
}

// é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + K: èšç„¦æœç´¢æ¡†
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('search-input').focus();
    }
    // ESC: æ¸…é™¤æœç´¢
    if (e.key === 'Escape') {
        clearFilters();
    }
});

// åŠ è½½æ•°æ®
loadWorkflows();
</script>

<!-- å¤åˆ¶æŒ‰é’®æ ·å¼ -->
<style>
.copy-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.2s;
    opacity: 0.6;
}
.copy-btn:hover {
    opacity: 1;
    background: #f0f0f0;
    transform: scale(1.1);
}
</style>

<!-- ä¹‹å‰çš„åˆ†é¡µæ ·å¼ -->
<style>
.pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 20px;
    gap: 20px;
}

.pagination-info {
    font-size: 14px;
    color: #4a5568;
}

.pagination-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.page-btn {
    background: white;
    border: 1.5px solid #e2e8f0;
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 13px;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.2s;
}

.page-btn:hover:not(:disabled) {
    background: #667eea;
    border-color: #667eea;
    color: white;
    transform: translateY(-1px);
}

.page-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    background: #f7fafc;
}

.page-numbers {
    display: flex;
    gap: 4px;
}

.page-numbers .page-number {
    min-width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: 1.5px solid #e2e8f0;
    background: white;
    color: #4a5568;
    transition: all 0.2s;
}

.page-numbers .page-number:hover {
    border-color: #667eea;
    color: #667eea;
}

.page-numbers .page-number.active {
    background: #667eea;
    border-color: #667eea;
    color: white;
    cursor: default;
}

.page-size-select {
    padding: 8px 12px;
    border: 1.5px solid #e2e8f0;
    border-radius: 8px;
    font-size: 13px;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}

.page-size-select:hover {
    border-color: #667eea;
}
</style>
{% endblock %}
