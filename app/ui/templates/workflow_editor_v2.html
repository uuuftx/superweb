<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œæµå¯è§†åŒ–ç¼–è¾‘å™¨ - SuperWeb</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            background: #0f0f23;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            height: 56px;
            background: linear-gradient(135deg, #1a1a3e 0%, #16213e 100%);
            border-bottom: 1px solid #2d2d5a;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .toolbar-brand {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-divider {
            width: 1px;
            height: 32px;
            background: #2d2d5a;
        }

        .toolbar-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .toolbar button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .toolbar button.secondary {
            background: transparent;
            border: 1px solid #3a3a5c;
            box-shadow: none;
        }

        .toolbar button.secondary:hover {
            background: #2a2a4a;
            border-color: #667eea;
        }

        .toolbar button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .toolbar button.danger:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            display: flex;
            height: calc(100vh - 56px);
        }

        /* å·¦ä¾§å·¥å…·é¢æ¿ */
        .tools-panel {
            width: 260px;
            background: linear-gradient(180deg, #1a1a3e 0%, #16213e 100%);
            border-right: 1px solid #2d2d5a;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
        }

        .tools-header {
            padding: 20px;
            border-bottom: 1px solid #2d2d5a;
            font-size: 14px;
            font-weight: 600;
            color: #e94560;
        }

        .tools-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .tool-section {
            margin-bottom: 20px;
        }

        .tool-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #7c7ca0;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tool-item {
            padding: 12px;
            background: #1f1f40;
            border: 1px solid #2d2d5a;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-item:hover {
            background: #2a2a50;
            border-color: #667eea;
            transform: translateX(4px);
        }

        .tool-item:active {
            cursor: grabbing;
        }

        .tool-item-icon {
            font-size: 20px;
        }

        .tool-item-text {
            font-size: 13px;
            color: #e0e0e0;
        }

        /* ç”»å¸ƒåŒºåŸŸ */
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #0f0f23;
        }

        #workflow-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: grab;
        }

        #workflow-canvas:active {
            cursor: grabbing;
        }

        /* èŠ‚ç‚¹æ ·å¼ */
        .node {
            position: absolute;
            background: linear-gradient(135deg, #1f1f40 0%, #1a1a3e 100%);
            border: 2px solid #3a3a6a;
            border-radius: 12px;
            padding: 15px;
            min-width: 180px;
            cursor: move;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            user-select: none;
        }

        .node:hover {
            border-color: #667eea;
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.3);
        }

        .node.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .node-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2d2d5a;
        }

        .node-icon {
            font-size: 24px;
        }

        .node-title {
            font-size: 14px;
            font-weight: 600;
            color: #e94560;
            flex: 1;
        }

        .node-number {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .node-content {
            font-size: 12px;
            color: #a0a0b8;
            line-height: 1.5;
        }

        .node-ports {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .node-port {
            width: 16px;
            height: 16px;
            background: #3a3a6a;
            border: 2px solid #667eea;
            border-radius: 50%;
            cursor: crosshair;
            transition: all 0.2s;
        }

        .node-port:hover {
            background: #667eea;
            transform: scale(1.2);
        }

        /* å³ä¾§å±æ€§é¢æ¿ */
        .properties-panel {
            width: 320px;
            background: linear-gradient(180deg, #1a1a3e 0%, #16213e 100%);
            border-left: 1px solid #2d2d5a;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
        }

        .properties-header {
            padding: 20px;
            border-bottom: 1px solid #2d2d5a;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
        }

        .properties-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .property-section {
            margin-bottom: 25px;
        }

        .property-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #7c7ca0;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .property-field {
            margin-bottom: 15px;
        }

        .property-label {
            display: block;
            font-size: 12px;
            color: #a0a0b8;
            margin-bottom: 6px;
        }

        .property-input {
            width: 100%;
            padding: 10px;
            background: #1f1f40;
            border: 1px solid #2d2d5a;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 13px;
            transition: all 0.2s;
        }

        .property-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .property-textarea {
            width: 100%;
            padding: 10px;
            background: #1f1f40;
            border: 1px solid #2d2d5a;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 13px;
            font-family: 'Monaco', 'Menlo', monospace;
            min-height: 200px;
            resize: vertical;
            transition: all 0.2s;
        }

        .property-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7c7ca0;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-state-hint {
            font-size: 13px;
            opacity: 0.7;
        }

        /* è¿æ¥çº¿SVG */
        #connections-svg {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 0;
        }

        .connection-line {
            stroke: #667eea;
            stroke-width: 3;
            fill: none;
            opacity: 0.8;
            filter: drop-shadow(0 0 3px rgba(102, 126, 234, 0.5));
        }

        .connection-line:hover {
            stroke-width: 4;
            opacity: 1;
            filter: drop-shadow(0 0 6px rgba(102, 126, 234, 0.8));
        }

        /* ç¼©æ”¾æ§åˆ¶ */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 8px;
            background: #1a1a3e;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #2d2d5a;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            background: #1f1f40;
            border: 1px solid #2d2d5a;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: #2a2a50;
            border-color: #667eea;
        }

        .zoom-level {
            padding: 8px 12px;
            color: #a0a0b8;
            font-size: 13px;
            font-weight: 600;
        }

        /* æç¤ºä¿¡æ¯ */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #1a1a3e;
            border: 1px solid #2d2d5a;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.info {
            border-left: 4px solid #667eea;
        }

        .toast-title {
            font-size: 14px;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 8px;
        }

        .toast-message {
            font-size: 13px;
            color: #a0a0b8;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-brand">
            <span>ğŸ”€</span>
            <span id="workflow-title">å·¥ä½œæµå¯è§†åŒ–ç¼–è¾‘å™¨</span>
        </div>

        <div class="toolbar-divider"></div>

        <div class="toolbar-group">
            <button id="toggle-workflow-btn" onclick="toggleWorkflowEnabled()">
                <span id="workflow-status-icon">ğŸ”´</span>
                <span id="workflow-status-text">å·²ç¦ç”¨</span>
            </button>
        </div>

        <div style="flex: 1;"></div>

        <div class="toolbar-group">
            <button class="secondary" onclick="addNode()">â• æ·»åŠ èŠ‚ç‚¹</button>
            <button class="secondary" onclick="autoLayout()">ğŸ“ è‡ªåŠ¨å¸ƒå±€</button>
            <button onclick="saveWorkflow()">ğŸ’¾ ä¿å­˜</button>
            <button class="secondary" onclick="showWorkflowSettings()">âš™ï¸ è®¾ç½®</button>
            <button class="secondary" onclick="viewExecutionLogs()">ğŸ“‹ æ—¥å¿—</button>
            <button class="secondary" onclick="showHelp()">â“ å¸®åŠ©</button>
            <button class="secondary" onclick="goBack()">â† è¿”å›</button>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- å·¦ä¾§å·¥å…·é¢æ¿ -->
        <div class="tools-panel">
            <div class="tools-header">ğŸ§° å·¥å…·ç®±</div>
            <div class="tools-content">
                <div class="tool-section">
                    <div class="tool-section-title">èŠ‚ç‚¹ç±»å‹</div>
                    <div class="tool-item" onclick="addNode()">
                        <span class="tool-item-icon">ğŸ“</span>
                        <span class="tool-item-text">Python è„šæœ¬</span>
                    </div>
                    <div class="tool-item" onclick="addNode('start')">
                        <span class="tool-item-icon">ğŸš€</span>
                        <span class="tool-item-text">å¼€å§‹èŠ‚ç‚¹</span>
                    </div>
                    <div class="tool-item" onclick="addNode('end')">
                        <span class="tool-item-icon">ğŸ</span>
                        <span class="tool-item-text">ç»“æŸèŠ‚ç‚¹</span>
                    </div>
                </div>

                <div class="tool-section">
                    <div class="tool-section-title">å¿«æ·æ“ä½œ</div>
                    <div class="tool-item" onclick="autoLayout()">
                        <span class="tool-item-icon">ğŸ“</span>
                        <span class="tool-item-text">è‡ªåŠ¨å¸ƒå±€</span>
                    </div>
                    <div class="tool-item" onclick="fitToScreen()">
                        <span class="tool-item-icon">ğŸ”</span>
                        <span class="tool-item-text">é€‚åº”å±å¹•</span>
                    </div>
                    <div class="tool-item" onclick="resetView()">
                        <span class="tool-item-icon">ğŸ”„</span>
                        <span class="tool-item-text">é‡ç½®è§†å›¾</span>
                    </div>
                </div>

                <div class="tool-section">
                    <div class="tool-section-title">ä¿¡æ¯</div>
                    <div style="font-size: 12px; color: #7c7ca0; line-height: 1.6;">
                        <div>èŠ‚ç‚¹æ•°: <span id="info-nodes">0</span></div>
                        <div>è¿æ¥æ•°: <span id="info-connections">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç”»å¸ƒåŒºåŸŸ -->
        <div class="canvas-container" id="canvas-container">
            <svg id="connections-svg"></svg>
            <div id="workflow-canvas"></div>

            <!-- ç¼©æ”¾æ§åˆ¶ -->
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomOut()">âˆ’</button>
                <span class="zoom-level" id="zoom-level">100%</span>
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="fitToScreen()" title="é€‚åº”å±å¹•">âŠ¡</button>
            </div>
        </div>

        <!-- å³ä¾§å±æ€§é¢æ¿ -->
        <div class="properties-panel">
            <div class="properties-header">ğŸ“ å±æ€§</div>
            <div class="properties-content" id="properties-content">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ¯</div>
                    <div class="empty-state-text">é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹</div>
                    <div class="empty-state-hint">ç‚¹å‡»ç”»å¸ƒä¸Šçš„èŠ‚ç‚¹è¿›è¡Œç¼–è¾‘</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== å…¨å±€çŠ¶æ€ ==========
        let currentWorkflow = null;
        let nodes = [];
        let connections = [];
        let selectedNodeId = null;
        let nextNodeNumber = 1;

        // ç”»å¸ƒçŠ¶æ€
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;
        let isDraggingCanvas = false;
        let isDraggingNode = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragNodeId = null;

        // è¿æ¥åˆ›å»º
        let isCreatingConnection = false;
        let connectionStartNodeId = null;

        // ========== API è¯·æ±‚ ==========
        async function api(url, options = {}) {
            const response = await fetch(url, {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || error.message || 'è¯·æ±‚å¤±è´¥');
            }

            return response.json();
        }

        // ========== åˆå§‹åŒ– ==========
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const workflowId = urlParams.get('workflow');

            if (workflowId) {
                await loadWorkflowById(workflowId);
            } else {
                showToast('é”™è¯¯', 'ç¼ºå°‘å·¥ä½œæµIDå‚æ•°ï¼Œè¯·ä»å·¥ä½œæµç®¡ç†é¡µé¢é€‰æ‹©å·¥ä½œæµ', 'error');
                setTimeout(() => goBack(), 1500);
            }

            // åˆå§‹åŒ–ç”»å¸ƒäº‹ä»¶
            initCanvasEvents();
        };

        function initCanvasEvents() {
            const container = document.getElementById('canvas-container');
            const canvas = document.getElementById('workflow-canvas');

            // ç”»å¸ƒæ‹–æ‹½
            container.addEventListener('mousedown', (e) => {
                if (e.target === container || e.target === canvas) {
                    isDraggingCanvas = true;
                    dragStartX = e.clientX - offsetX;
                    dragStartY = e.clientY - offsetY;
                    canvas.style.cursor = 'grabbing';
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (isDraggingCanvas) {
                    offsetX = e.clientX - dragStartX;
                    offsetY = e.clientY - dragStartY;
                    updateCanvasTransform();
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDraggingCanvas) {
                    isDraggingCanvas = false;
                    canvas.style.cursor = 'grab';
                }
            });

            // æ»šè½®ç¼©æ”¾
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newScale = Math.max(0.3, Math.min(2, scale + delta));
                scale = newScale;
                updateCanvasTransform();
                updateZoomLevel();
            });
        }

        function updateCanvasTransform() {
            const canvas = document.getElementById('workflow-canvas');
            const svg = document.getElementById('connections-svg');
            const transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
            canvas.style.transform = transform;
            svg.style.transform = transform;
        }

        function updateZoomLevel() {
            document.getElementById('zoom-level').textContent = Math.round(scale * 100) + '%';
        }

        // ========== èŠ‚ç‚¹ç®¡ç† ==========
        function addNode(type = 'python') {
            const nodeNumber = nextNodeNumber++;
            const nodeId = `node_${nodeNumber}`;

            // è‡ªåŠ¨è®¡ç®—ä½ç½®
            const x = 100 + nodes.length * 250;
            const y = 100;

            const node = {
                id: nodeId,
                node_number: nodeNumber,
                name: `èŠ‚ç‚¹${nodeNumber}`,
                type: type,
                x: x,
                y: y,
                code: generateDefaultCode(nodeNumber),
                description: ''
            };

            nodes.push(node);
            renderNode(node);
            updateInfo();
            selectNode(nodeId);
        }

        function generateDefaultCode(nodeNumber) {
            return `# èŠ‚ç‚¹ ${nodeNumber} - Python è„šæœ¬

# å¯ç”¨å˜é‡:
# data: ä¸Šä¸€ä¸ªèŠ‚ç‚¹ä¼ é€’çš„æ•°æ®
# context: è¯·æ±‚ä¸Šä¸‹æ–‡ (path, query, headers, body)

# å¤„ç†æ•°æ®
data = data or {}
result = {
    "message": f"èŠ‚ç‚¹ ${nodeNumber} å¤„ç†å®Œæˆ",
    "node": ${nodeNumber},
    "data": data
}

# è¿”å›: next_node, data
# next_node: ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ç¼–å· (æ•´æ•°), 0 è¡¨ç¤ºç»“æŸ
next_node = ${nodeNumber + 1}`;
        }

        function renderNode(node) {
            const canvas = document.getElementById('workflow-canvas');
            const nodeEl = document.createElement('div');
            nodeEl.className = 'node';
            nodeEl.id = node.id;
            nodeEl.style.left = node.x + 'px';
            nodeEl.style.top = node.y + 'px';

            const iconMap = {
                'python': 'ğŸ“',
                'start': 'ğŸš€',
                'end': 'ğŸ'
            };

            nodeEl.innerHTML = `
                <div class="node-header">
                    <span class="node-icon">${iconMap[node.type] || 'ğŸ“'}</span>
                    <span class="node-title">${node.name}</span>
                    <span class="node-number">#${node.node_number}</span>
                </div>
                <div class="node-content">${node.description || 'Python è„šæœ¬èŠ‚ç‚¹'}</div>
                <div class="node-ports">
                    <div class="node-port" data-port="input" title="è¾“å…¥"></div>
                    <div class="node-port" data-port="output" title="è¾“å‡º"></div>
                </div>
            `;

            // èŠ‚ç‚¹äº‹ä»¶
            nodeEl.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('node-port')) {
                    handlePortClick(e, node.id);
                    return;
                }

                e.stopPropagation();
                selectNode(node.id);

                isDraggingNode = true;
                dragNodeId = node.id;
                dragStartX = e.clientX / scale - node.x;
                dragStartY = e.clientY / scale - node.y;
            });

            canvas.appendChild(nodeEl);
        }

        function selectNode(nodeId) {
            // å–æ¶ˆä¹‹å‰çš„é€‰ä¸­
            if (selectedNodeId) {
                const prevNode = document.getElementById(selectedNodeId);
                if (prevNode) prevNode.classList.remove('selected');
            }

            selectedNodeId = nodeId;

            if (nodeId) {
                const nodeEl = document.getElementById(nodeId);
                if (nodeEl) nodeEl.classList.add('selected');
                showNodeProperties(nodeId);
            } else {
                showEmptyProperties();
            }
        }

        function showNodeProperties(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;

            const content = document.getElementById('properties-content');
            content.innerHTML = `
                <div class="property-section">
                    <div class="property-section-title">åŸºæœ¬ä¿¡æ¯</div>
                    <div class="property-field">
                        <label class="property-label">èŠ‚ç‚¹åç§°</label>
                        <input type="text" class="property-input" id="prop-name" value="${node.name}">
                    </div>
                    <div class="property-field">
                        <label class="property-label">æè¿°</label>
                        <input type="text" class="property-input" id="prop-description" value="${node.description || ''}">
                    </div>
                    <div class="property-field">
                        <label class="property-label">èŠ‚ç‚¹ç¼–å·</label>
                        <input type="text" class="property-input" value="${node.node_number}" disabled style="opacity: 0.6;">
                    </div>
                </div>

                <div class="property-section">
                    <div class="property-section-title">Python ä»£ç </div>
                    <div class="property-field">
                        <textarea class="property-textarea" id="prop-code">${node.code || ''}</textarea>
                    </div>
                </div>

                <div class="property-section">
                    <button class="toolbar-button danger" style="width: 100%; justify-content: center;" onclick="deleteNode('${nodeId}')">
                        ğŸ—‘ï¸ åˆ é™¤èŠ‚ç‚¹
                    </button>
                </div>
            `;

            // ç»‘å®šä¿å­˜äº‹ä»¶
            document.getElementById('prop-name').addEventListener('input', (e) => {
                node.name = e.target.value;
                const nodeEl = document.getElementById(nodeId);
                nodeEl.querySelector('.node-title').textContent = node.name;
            });

            document.getElementById('prop-description').addEventListener('input', (e) => {
                node.description = e.target.value;
            });

            document.getElementById('prop-code').addEventListener('input', (e) => {
                node.code = e.target.value;
            });
        }

        function showEmptyProperties() {
            const content = document.getElementById('properties-content');
            content.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ¯</div>
                    <div class="empty-state-text">é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹</div>
                    <div class="empty-state-hint">ç‚¹å‡»ç”»å¸ƒä¸Šçš„èŠ‚ç‚¹è¿›è¡Œç¼–è¾‘</div>
                </div>
            `;
        }

        function deleteNode(nodeId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹å—ï¼Ÿ')) return;

            // åˆ é™¤èŠ‚ç‚¹
            nodes = nodes.filter(n => n.id !== nodeId);

            // åˆ é™¤ç›¸å…³è¿æ¥
            connections = connections.filter(c => c.source !== nodeId && c.target !== nodeId);

            // åˆ é™¤DOM
            const nodeEl = document.getElementById(nodeId);
            if (nodeEl) nodeEl.remove();

            // é‡æ–°æ¸²æŸ“è¿æ¥
            renderConnections();

            if (selectedNodeId === nodeId) {
                selectedNodeId = null;
                showEmptyProperties();
            }

            updateInfo();
        }

        // ========== è¿æ¥ç®¡ç† ==========
        function handlePortClick(e, nodeId) {
            e.stopPropagation();

            if (!isCreatingConnection) {
                // å¼€å§‹åˆ›å»ºè¿æ¥
                isCreatingConnection = true;
                connectionStartNodeId = nodeId;
                showToast('åˆ›å»ºè¿æ¥', 'è¯·ç‚¹å‡»ç›®æ ‡èŠ‚ç‚¹çš„è¾“å…¥ç«¯å£', 'info');
            } else {
                // å®Œæˆè¿æ¥
                if (connectionStartNodeId && connectionStartNodeId !== nodeId) {
                    createConnection(connectionStartNodeId, nodeId);
                }
                isCreatingConnection = false;
                connectionStartNodeId = null;
            }
        }

        function createConnection(sourceId, targetId) {
            // æ£€æŸ¥è¿æ¥æ˜¯å¦å·²å­˜åœ¨
            const exists = connections.some(c => c.source === sourceId && c.target === targetId);
            if (exists) {
                showToast('é”™è¯¯', 'è¿æ¥å·²å­˜åœ¨', 'error');
                return;
            }

            connections.push({
                source: sourceId,
                target: targetId
            });

            renderConnections();
            updateInfo();
            showToast('æˆåŠŸ', 'è¿æ¥å·²åˆ›å»º', 'success');
        }

        function renderConnections() {
            const svg = document.getElementById('connections-svg');

            // æ¸…ç©ºç°æœ‰å†…å®¹ï¼ˆä½†ä¿ç•™defsï¼‰
            const existingDefs = svg.querySelector('defs');
            svg.innerHTML = '';
            if (existingDefs) {
                svg.appendChild(existingDefs);
            }

            // ç¡®ä¿ç®­å¤´æ ‡è®°å­˜åœ¨
            ensureArrowMarker(svg);

            connections.forEach(conn => {
                const sourceNode = nodes.find(n => n.id === conn.source);
                const targetNode = nodes.find(n => n.id === conn.target);

                if (!sourceNode || !targetNode) return;

                // è®¡ç®—ç«¯å£ä½ç½®
                const sourceX = sourceNode.x + 180; // è¾“å‡ºç«¯å£åœ¨å³ä¾§
                const sourceY = sourceNode.y + 70;
                const targetX = targetNode.x; // è¾“å…¥ç«¯å£åœ¨å·¦ä¾§
                const targetY = targetNode.y + 70;

                // åˆ›å»ºè´å¡å°”æ›²çº¿
                const midX = (sourceX + targetX) / 2;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${sourceX} ${sourceY} C ${midX} ${sourceY}, ${midX} ${targetY}, ${targetX} ${targetY}`);
                path.setAttribute('class', 'connection-line');
                path.setAttribute('marker-end', 'url(#arrowhead)');

                svg.appendChild(path);
            });
        }

        function ensureArrowMarker(svg) {
            if (document.getElementById('arrowhead')) return;

            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            defs.setAttribute('id', 'svg-defs');

            // åˆ›å»ºç®­å¤´æ ‡è®°
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead');
            marker.setAttribute('markerWidth', '12');
            marker.setAttribute('markerHeight', '12');
            marker.setAttribute('refX', '10');
            marker.setAttribute('refY', '6');
            marker.setAttribute('orient', 'auto');

            // åˆ›å»ºç®­å¤´è·¯å¾„ï¼ˆæ›´å¤§çš„ä¸‰è§’å½¢ï¼‰
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            polygon.setAttribute('d', 'M 0 0 L 12 6 L 0 12 L 3 6 Z');
            polygon.setAttribute('fill', '#667eea');

            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);
        }

        // ========== å·¥ä½œæµæ“ä½œ ==========
        async function loadWorkflowById(workflowId) {
            try {
                const data = await api(`/api/admin/workflows/${workflowId}/detail`);
                currentWorkflow = data.workflow;
                document.getElementById('workflow-title').textContent = currentWorkflow.name;

                // åŠ è½½èŠ‚ç‚¹
                nodes = data.nodes.map(n => ({
                    id: n.id,
                    node_number: n.id.startsWith('node_') ? parseInt(n.id.split('_')[1]) : 1,
                    name: n.name,
                    type: n.type || 'python',
                    x: n.x,
                    y: n.y,
                    code: n.config?.code || '',
                    description: n.config?.description || ''
                }));

                // åŠ è½½è¿æ¥
                connections = (data.connections || []).map(c => ({
                    source: c.source,
                    target: c.target
                }));

                // è®¡ç®—ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç¼–å·
                if (nodes.length > 0) {
                    nextNodeNumber = Math.max(...nodes.map(n => n.node_number)) + 1;
                }

                // æ¸²æŸ“
                renderAllNodes();
                renderConnections();
                updateInfo();
                updateWorkflowStatusButton();
                fitToScreen();
            } catch (error) {
                console.error('åŠ è½½å·¥ä½œæµå¤±è´¥:', error);
                showToast('é”™è¯¯', 'åŠ è½½å·¥ä½œæµå¤±è´¥: ' + error.message, 'error');
            }
        }

        function renderAllNodes() {
            const canvas = document.getElementById('workflow-canvas');
            canvas.innerHTML = '';
            nodes.forEach(node => renderNode(node));
        }

        async function saveWorkflow() {
            if (!currentWorkflow) {
                showToast('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºæµç¨‹', 'error');
                return;
            }

            const workflowData = {
                nodes: nodes.map(n => ({
                    node_id: n.id,
                    node_type: 'python',
                    name: n.name,
                    position_x: n.x,
                    position_y: n.y,
                    config: {
                        code: n.code,
                        description: n.description
                    }
                })),
                connections: connections
            };

            try {
                await api(`/api/admin/workflows/${currentWorkflow.id}/nodes`, {
                    method: 'POST',
                    body: JSON.stringify(workflowData)
                });
                showToast('ä¿å­˜æˆåŠŸ', `å·¥ä½œæµ "${currentWorkflow.name}" å·²ä¿å­˜ï¼Œå…± ${nodes.length} ä¸ªèŠ‚ç‚¹ï¼Œ${connections.length} æ¡è¿æ¥`, 'success');
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥', error.message, 'error');
            }
        }

        // ========== è§†å›¾æ“ä½œ ==========
        function autoLayout() {
            const startX = 100;
            const startY = 100;
            const horizontalGap = 280;
            const verticalGap = 150;

            // ç®€å•çš„å±‚çº§å¸ƒå±€
            const levels = {};
            const visited = new Set();

            function getLevel(nodeId, level = 0) {
                if (visited.has(nodeId)) return levels[nodeId] || 0;
                visited.add(nodeId);

                const inputs = connections.filter(c => c.target === nodeId);
                if (inputs.length === 0) {
                    levels[nodeId] = 0;
                    return 0;
                }

                const inputLevels = inputs.map(c => getLevel(c.source, level + 1));
                const maxLevel = Math.max(...inputLevels);
                levels[nodeId] = maxLevel + 1;
                return maxLevel + 1;
            }

            nodes.forEach(node => getLevel(node.id));

            // æŒ‰å±‚çº§åˆ†ç»„
            const levelGroups = {};
            Object.entries(levels).forEach(([nodeId, level]) => {
                if (!levelGroups[level]) levelGroups[level] = [];
                levelGroups[level].push(nodeId);
            });

            // è®¾ç½®ä½ç½®
            Object.entries(levelGroups).forEach(([level, nodeIds]) => {
                nodeIds.forEach((nodeId, index) => {
                    const node = nodes.find(n => n.id === nodeId);
                    if (node) {
                        node.x = startX + parseInt(level) * horizontalGap;
                        node.y = startY + index * verticalGap;

                        const nodeEl = document.getElementById(nodeId);
                        if (nodeEl) {
                            nodeEl.style.left = node.x + 'px';
                            nodeEl.style.top = node.y + 'px';
                        }
                    }
                });
            });

            renderConnections();
            fitToScreen();
        }

        function fitToScreen() {
            if (nodes.length === 0) return;

            const container = document.getElementById('canvas-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            // è®¡ç®—è¾¹ç•Œ
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            nodes.forEach(node => {
                minX = Math.min(minX, node.x);
                minY = Math.min(minY, node.y);
                maxX = Math.max(maxX, node.x + 180);
                maxY = Math.max(maxY, node.y + 120);
            });

            const contentWidth = maxX - minX;
            const contentHeight = maxY - minY;

            // è®¡ç®—ç¼©æ”¾
            const padding = 100;
            const scaleX = (containerWidth - padding) / contentWidth;
            const scaleY = (containerHeight - padding) / contentHeight;
            scale = Math.min(scaleX, scaleY, 1.5);
            scale = Math.max(0.3, scale);

            // è®¡ç®—åç§»
            offsetX = (containerWidth - contentWidth * scale) / 2 - minX * scale;
            offsetY = (containerHeight - contentHeight * scale) / 2 - minY * scale;

            updateCanvasTransform();
            updateZoomLevel();
        }

        function resetView() {
            scale = 1;
            offsetX = 0;
            offsetY = 0;
            updateCanvasTransform();
            updateZoomLevel();
        }

        function zoomIn() {
            scale = Math.min(2, scale + 0.1);
            updateCanvasTransform();
            updateZoomLevel();
        }

        function zoomOut() {
            scale = Math.max(0.3, scale - 0.1);
            updateCanvasTransform();
            updateZoomLevel();
        }

        // ========== è¾…åŠ©åŠŸèƒ½ ==========
        function updateInfo() {
            document.getElementById('info-nodes').textContent = nodes.length;
            document.getElementById('info-connections').textContent = connections.length;
        }

        function toggleWorkflowEnabled() {
            if (!currentWorkflow) {
                showToast('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©å·¥ä½œæµ', 'error');
                return;
            }

            const newEnabled = !currentWorkflow.enabled;

            api(`/api/admin/workflows/${currentWorkflow.id}`, {
                method: 'PATCH',
                body: JSON.stringify({ enabled: newEnabled })
            }).then(() => {
                currentWorkflow.enabled = newEnabled;
                updateWorkflowStatusButton();
                showToast('ä¿å­˜æˆåŠŸ', `å·¥ä½œæµå·²${newEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'success');
            }).catch(error => {
                showToast('ä¿å­˜å¤±è´¥', error.message, 'error');
            });
        }

        function updateWorkflowStatusButton() {
            const icon = document.getElementById('workflow-status-icon');
            const text = document.getElementById('workflow-status-text');
            const btn = document.getElementById('toggle-workflow-btn');

            if (currentWorkflow && currentWorkflow.enabled) {
                icon.textContent = 'ğŸŸ¢';
                text.textContent = 'å·²å¯ç”¨';
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                btn.style.color = 'white';
            } else {
                icon.textContent = 'ğŸ”´';
                text.textContent = 'å·²ç¦ç”¨';
                btn.style.background = '';
                btn.style.color = '';
            }
        }

        function showWorkflowSettings() {
            if (!currentWorkflow) {
                showToast('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©å·¥ä½œæµ', 'error');
                return;
            }
            window.location.href = `/ui/workflow-editor?workflow=${currentWorkflow.id}`;
        }

        function viewExecutionLogs() {
            if (!currentWorkflow) {
                showToast('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©å·¥ä½œæµ', 'error');
                return;
            }
            window.location.href = `/ui/workflow-logs?workflow_id=${currentWorkflow.id}`;
        }

        function showHelp() {
            showToast('å¸®åŠ©', `
                <strong>èŠ‚ç‚¹æ“ä½œï¼š</strong><br>
                â€¢ ç‚¹å‡»èŠ‚ç‚¹è¿›è¡Œç¼–è¾‘<br>
                â€¢ æ‹–æ‹½èŠ‚ç‚¹ç§»åŠ¨ä½ç½®<br>
                â€¢ ç‚¹å‡»ç«¯å£åˆ›å»ºè¿æ¥<br><br>
                <strong>è§†å›¾æ“ä½œï¼š</strong><br>
                â€¢ æ‹–æ‹½ç”»å¸ƒå¹³ç§»<br>
                â€¢ æ»šè½®ç¼©æ”¾è§†å›¾<br>
                â€¢ è‡ªåŠ¨å¸ƒå±€æ•´ç†èŠ‚ç‚¹
            `, 'info', 0);
        }

        function goBack() {
            window.history.back();
        }

        function showToast(title, message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            `;
            document.body.appendChild(toast);

            if (duration > 0) {
                setTimeout(() => toast.remove(), duration);
            }
        }

        // å…¨å±€èŠ‚ç‚¹æ‹–æ‹½
        document.addEventListener('mousemove', (e) => {
            if (isDraggingNode && dragNodeId) {
                const node = nodes.find(n => n.id === dragNodeId);
                if (node) {
                    node.x = e.clientX / scale - dragStartX;
                    node.y = e.clientY / scale - dragStartY;

                    const nodeEl = document.getElementById(dragNodeId);
                    if (nodeEl) {
                        nodeEl.style.left = node.x + 'px';
                        nodeEl.style.top = node.y + 'px';
                    }

                    renderConnections();
                }
            }
        });

        document.addEventListener('mouseup', () => {
            isDraggingNode = false;
            dragNodeId = null;
        });

        // ESC å–æ¶ˆé€‰æ‹©
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                selectNode(null);
                isCreatingConnection = false;
                connectionStartNodeId = null;
            }
        });
    </script>
</body>
</html>
