<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API æµç¨‹ç¼–æ’ - SuperWeb</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            background: #1a1a2e;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            height: 50px;
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            border-bottom: 1px solid #3a3a5c;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
        }

        .toolbar-brand {
            font-size: 18px;
            font-weight: 600;
            color: #e94560;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-divider {
            width: 1px;
            height: 30px;
            background: #3a3a5c;
        }

        .toolbar-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .toolbar-label {
            color: #a0a0b8;
            font-size: 12px;
            font-weight: 500;
        }

        .toolbar select {
            background: #1a1a2e;
            border: 1px solid #3a3a5c;
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .toolbar button {
            background: #e94560;
            color: white;
            border: none;
            padding: 7px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toolbar button:hover {
            background: #ff6b6b;
            transform: translateY(-1px);
        }

        .toolbar button.secondary {
            background: transparent;
            border: 1px solid #3a3a5c;
        }

        .toolbar button.secondary:hover {
            background: #3a3a5c;
        }

        /* ä¸»å¸ƒå±€ */
        .editor-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* å·¦ä¾§èŠ‚ç‚¹é¢æ¿ */
        .nodes-panel {
            width: 280px;
            background: #16213e;
            border-right: 1px solid #3a3a5c;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 15px;
            border-bottom: 1px solid #3a3a5c;
            color: #fff;
            font-weight: 600;
            font-size: 14px;
        }

        .nodes-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .workflow-node-item {
            background: #1a1a2e;
            border: 2px solid #3a3a5c;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .workflow-node-item:hover {
            border-color: #e94560;
        }

        .workflow-node-item.selected {
            border-color: #e94560;
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
        }

        .node-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .node-number {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .node-name {
            flex: 1;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
        }

        .node-desc {
            color: #a0a0b8;
            font-size: 12px;
            line-height: 1.4;
        }

        .add-node-btn {
            width: 100%;
            background: #3b82f6;
            border: none;
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .add-node-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        /* ä¸­é—´ç¼–è¾‘åŒº */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0f0f1a;
        }

        .editor-toolbar {
            height: 50px;
            background: #1a1a2e;
            border-bottom: 1px solid #3a3a5c;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 10px;
        }

        .editor-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            color: #6a6a8a;
            padding: 80px 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-state-hint {
            font-size: 13px;
        }

        /* èŠ‚ç‚¹ç¼–è¾‘è¡¨å• */
        .node-edit-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-section {
            background: #1a1a2e;
            border: 1px solid #3a3a5c;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-section-title {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3a3a5c;
        }

        .form-field {
            margin-bottom: 15px;
        }

        .form-field label {
            display: block;
            color: #a0a0b8;
            font-size: 13px;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .form-field input,
        .form-field textarea,
        .form-field select {
            width: 100%;
            background: #0f0f1a;
            border: 1px solid #3a3a5c;
            color: #fff;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-field input:focus,
        .form-field textarea:focus,
        .form-field select:focus {
            outline: none;
            border-color: #e94560;
        }

        .form-field textarea {
            min-height: 300px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .form-field .code-editor {
            background: #0f0f1a;
            border: 1px solid #3a3a5c;
            border-radius: 6px;
            padding: 15px;
        }

        .form-help {
            color: #6a6a8a;
            font-size: 12px;
            margin-top: 6px;
            line-height: 1.5;
        }

        .form-help code {
            background: #2a2a4a;
            padding: 2px 6px;
            border-radius: 4px;
            color: #e94560;
        }

        /* æŒ‰é’® */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #e94560;
            color: white;
        }

        .btn-primary:hover {
            background: #ff6b6b;
        }

        .btn-secondary {
            background: #3a3a5c;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a4a6c;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* åº•éƒ¨çŠ¶æ€æ  */
        .statusbar {
            height: 30px;
            background: #16213e;
            border-top: 1px solid #3a3a5c;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 20px;
        }

        .statusbar-item {
            color: #a0a0b8;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .statusbar-item span {
            color: #fff;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border: 1px solid #3a3a5c;
        }

        .modal-title {
            color: #fff;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a2e;
        }

        ::-webkit-scrollbar-thumb {
            background: #3a3a5c;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4a4a6c;
        }

        /* Toast é€šçŸ¥æ ·å¼ */
        .toast-container {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 300px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            transition: all 0.3s;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.info {
            border-left: 4px solid #3b82f6;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            color: #1a202c;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 13px;
            color: #718096;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #a0aec0;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .toast-close:hover {
            background: #f7fafc;
            color: #4a5568;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }

        .toast.removing {
            animation: fadeOut 0.3s ease-out forwards;
        }

        /* ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        .confirm-dialog.active {
            display: flex;
        }

        .confirm-box {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .confirm-header {
            padding: 24px 28px 20px;
            text-align: center;
        }

        .confirm-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .confirm-title {
            font-size: 20px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .confirm-message {
            font-size: 14px;
            color: #718096;
            line-height: 1.6;
        }

        .confirm-footer {
            display: flex;
            gap: 12px;
            padding: 20px 28px;
            border-top: 1px solid #f0f0f0;
            background: #fafafa;
            border-radius: 0 0 16px 16px;
        }

        .confirm-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .confirm-btn-cancel {
            background: #f7fafc;
            color: #4a5568;
            border: 1.5px solid #e2e8f0;
        }

        .confirm-btn-cancel:hover {
            background: #e2e8f0;
        }

        .confirm-btn-confirm {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .confirm-btn-confirm:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <!-- Toast å®¹å™¨ -->
    <div class="toast-container" id="toast-container"></div>

    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="confirm-dialog" id="confirm-dialog">
        <div class="confirm-box">
            <div class="confirm-header">
                <div class="confirm-icon">ğŸ—‘ï¸</div>
                <div class="confirm-title" id="confirm-title">ç¡®è®¤åˆ é™¤</div>
                <div class="confirm-message" id="confirm-message">ç¡®å®šè¦åˆ é™¤æ­¤é¡¹å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</div>
            </div>
            <div class="confirm-footer">
                <button class="confirm-btn confirm-btn-cancel" id="confirm-cancel">å–æ¶ˆ</button>
                <button class="confirm-btn confirm-btn-confirm" id="confirm-ok">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-brand">
            <span>ğŸ”€</span>
            <span id="workflow-title">API æµç¨‹ç¼–æ’</span>
        </div>
        <div style="flex: 1;"></div>
        <div class="toolbar-group">
            <button class="secondary" id="toggle-workflow-btn" onclick="toggleWorkflowEnabled()">
                <span id="workflow-status-icon">ğŸ”´</span>
                <span id="workflow-status-text">å·²ç¦ç”¨</span>
            </button>
            <button class="secondary" onclick="saveWorkflow()">ğŸ’¾ ä¿å­˜</button>
            <button class="secondary" onclick="showWorkflowSettings()">âš™ï¸ è®¾ç½®</button>
            <button class="secondary" onclick="showHelp()">â“ å¸®åŠ©</button>
            <button class="secondary" onclick="goBack()">â† è¿”å›</button>
        </div>
    </div>

    <!-- ä¸»ç¼–è¾‘åŒºåŸŸ -->
    <div class="editor-container">
        <!-- å·¦ä¾§èŠ‚ç‚¹åˆ—è¡¨ -->
        <div class="nodes-panel">
            <div class="panel-header">ğŸ“‹ èŠ‚ç‚¹åˆ—è¡¨</div>
            <div class="nodes-list" id="nodes-list">
                <div class="empty-state" style="padding: 40px 10px;">
                    <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“­</div>
                    <div style="font-size: 13px;">æš‚æ— èŠ‚ç‚¹</div>
                </div>
            </div>
            <div style="padding: 15px; border-top: 1px solid #3a3a5c;">
                <button class="add-node-btn" onclick="addNode()">
                    <span>+</span>
                    <span>æ·»åŠ èŠ‚ç‚¹</span>
                </button>
            </div>
        </div>

        <!-- ä¸­é—´ç¼–è¾‘åŒº -->
        <div class="editor-area">
            <div class="editor-toolbar">
                <span style="color: #a0a0b8; font-size: 13px;">ç¼–è¾‘èŠ‚ç‚¹</span>
            </div>
            <div class="editor-content" id="editor-content">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ¯</div>
                    <div class="empty-state-text">é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹ç¼–è¾‘</div>
                    <div class="empty-state-hint">ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©èŠ‚ç‚¹ï¼Œæˆ–æ·»åŠ æ–°èŠ‚ç‚¹</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨çŠ¶æ€æ  -->
    <div class="statusbar">
        <div class="statusbar-item">èŠ‚ç‚¹: <span id="status-nodes">0</span></div>
        <div style="flex: 1;"></div>
        <div class="statusbar-item">å½“å‰æµç¨‹: <span id="status-workflow">æœªé€‰æ‹©</span></div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let workflows = [];
        let currentWorkflow = null;
        let nodes = [];
        let selectedNodeId = null;
        let nextNodeNumber = 1;

        // API è¯·æ±‚å‡½æ•°
        async function api(url, options = {}) {
            const response = await fetch(url, {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });
            if (!response.ok) {
                throw new Error(await response.text());
            }
            return response.json();
        }

        // Toast é€šçŸ¥å‡½æ•°
        function showToast(title, message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
            `;

            container.appendChild(toast);

            // è‡ªåŠ¨ç§»é™¤
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }

            return toast;
        }

        // ç¡®è®¤å¯¹è¯æ¡†å‡½æ•°
        function showConfirm(title, message, onConfirm, options = {}) {
            const dialog = document.getElementById('confirm-dialog');
            const titleEl = document.getElementById('confirm-title');
            const messageEl = document.getElementById('confirm-message');
            const cancelBtn = document.getElementById('confirm-cancel');
            const okBtn = document.getElementById('confirm-ok');

            // è®¾ç½®å†…å®¹
            titleEl.textContent = title || 'ç¡®è®¤æ“ä½œ';
            messageEl.textContent = message || 'ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ';

            // è®¾ç½®æŒ‰é’®æ–‡æœ¬
            cancelBtn.textContent = options.cancelText || 'å–æ¶ˆ';
            okBtn.textContent = options.confirmText || 'ç¡®è®¤';

            // è®¾ç½®å›¾æ ‡
            const iconEl = dialog.querySelector('.confirm-icon');
            iconEl.textContent = options.icon || 'âš ï¸';

            // æ˜¾ç¤ºå¯¹è¯æ¡†
            dialog.classList.add('active');

            // è¿”å› Promise
            return new Promise((resolve) => {
                const cleanup = () => {
                    dialog.classList.remove('active');
                    cancelBtn.onclick = null;
                    okBtn.onclick = null;
                };

                cancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };

                okBtn.onclick = () => {
                    cleanup();
                    if (onConfirm) {
                        onConfirm();
                    }
                    resolve(true);
                };

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                dialog.onclick = (e) => {
                    if (e.target === dialog) {
                        cleanup();
                        resolve(false);
                    }
                };
            });
        }

        // åˆå§‹åŒ–
        async function init() {
            // ä»URLå‚æ•°è·å–workflow_id
            const urlParams = new URLSearchParams(window.location.search);
            const workflowId = urlParams.get('workflow');

            if (workflowId) {
                await loadWorkflowById(workflowId);
            } else {
                showToast('é”™è¯¯', 'ç¼ºå°‘å·¥ä½œæµIDå‚æ•°ï¼Œè¯·ä»å·¥ä½œæµç®¡ç†é¡µé¢é€‰æ‹©å·¥ä½œæµ', 'error', 5000);
                setTimeout(() => goBack(), 1500);
            }
        }

        // æ·»åŠ èŠ‚ç‚¹
        function addNode() {
            if (!currentWorkflow) {
                showToast('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©å·¥ä½œæµ', 'error');
                return;
            }

            const nodeNumber = nextNodeNumber++;
            const node = {
                id: `node_${nodeNumber}`,
                node_number: nodeNumber,
                name: `èŠ‚ç‚¹${nodeNumber}`,
                code: `# èŠ‚ç‚¹ ${nodeNumber} - Python è„šæœ¬\n\n# å¯ç”¨å˜é‡:\n# request: HTTP è¯·æ±‚å¯¹è±¡\n# data: ä¸Šä¸€ä¸ªèŠ‚ç‚¹ä¼ é€’çš„æ•°æ®\n# context: è¯·æ±‚ä¸Šä¸‹æ–‡ (path, query, headers, body)\n\n# å¤„ç†æ•°æ®\ndata = data or {}\n\n# è¿”å›: next_node, data\n# next_node: ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ç¼–å· (æ•´æ•°)\n# data: ä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®\n\nnext_node = ${nodeNumber + 1}\nresult = {\n    "message": f"å¤„ç†å®Œæˆ",\n    "node": ${nodeNumber},\n    "data": data\n}`,
                description: `å¤„ç†èŠ‚ç‚¹ ${nodeNumber} çš„é€»è¾‘`
            };

            nodes.push(node);
            renderNodesList();
            selectNode(node.id);
            updateStatus();
        }

        // æ¸²æŸ“èŠ‚ç‚¹åˆ—è¡¨
        function renderNodesList() {
            console.log('renderNodesList è¢«è°ƒç”¨, nodes.length:', nodes.length);
            const container = document.getElementById('nodes-list');

            if (nodes.length === 0) {
                console.log('èŠ‚ç‚¹åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px 10px;">
                        <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“­</div>
                        <div style="font-size: 13px;">æš‚æ— èŠ‚ç‚¹</div>
                    </div>
                `;
                return;
            }

            // æŒ‰èŠ‚ç‚¹ç¼–å·æ’åº
            const sortedNodes = [...nodes].sort((a, b) => a.node_number - b.node_number);
            console.log('æ’åºåçš„èŠ‚ç‚¹:', sortedNodes);

            container.innerHTML = sortedNodes.map(node => `
                <div class="workflow-node-item ${selectedNodeId === node.id ? 'selected' : ''}" onclick="selectNode('${node.id}')">
                    <div class="node-item-header">
                        <div class="node-number">${node.node_number}</div>
                        <div class="node-name">${node.name}</div>
                    </div>
                    <div class="node-desc">${node.description || 'æ— æè¿°'}</div>
                </div>
            `).join('');
            console.log('èŠ‚ç‚¹åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
        }

        // é€‰æ‹©èŠ‚ç‚¹
        function selectNode(nodeId) {
            selectedNodeId = nodeId;
            const node = nodes.find(n => n.id === nodeId);

            if (!node) {
                showEmptyEditor();
                return;
            }

            renderNodesList();
            showNodeEditor(node);
        }

        // æ˜¾ç¤ºèŠ‚ç‚¹ç¼–è¾‘å™¨
        function showNodeEditor(node) {
            const content = document.getElementById('editor-content');

            content.innerHTML = `
                <div class="node-edit-form">
                    <div class="form-section">
                        <div class="form-section-title">åŸºæœ¬ä¿¡æ¯</div>
                        <div class="form-field">
                            <label>èŠ‚ç‚¹ç¼–å·</label>
                            <input type="number" value="${node.node_number}" disabled style="opacity: 0.6;">
                        </div>
                        <div class="form-field">
                            <label>èŠ‚ç‚¹åç§°</label>
                            <input type="text" id="node-name" value="${node.name}" placeholder="èŠ‚ç‚¹åç§°">
                        </div>
                        <div class="form-field">
                            <label>æè¿°</label>
                            <textarea id="node-description" rows="2" placeholder="æè¿°è¿™ä¸ªèŠ‚ç‚¹çš„åŠŸèƒ½...">${node.description || ''}</textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Python è„šæœ¬</div>
                        <div class="form-field">
                            <label>ä»£ç </label>
                            <textarea id="node-code" rows="20" placeholder="è¾“å…¥ Python ä»£ç ..." style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 13px; line-height: 1.6;">${node.code || ''}</textarea>
                            <div class="form-help">
                                <p>å¯ç”¨å˜é‡:</p>
                                <p><code>request</code> - FastAPI Request å¯¹è±¡</p>
                                <p><code>data</code> - ä¸Šä¸€ä¸ªèŠ‚ç‚¹ä¼ é€’çš„æ•°æ®</p>
                                <p><code>context</code> - ä¸Šä¸‹æ–‡ {path, query, headers, body}</p>
                                <p style="margin-top: 10px;">è¿”å›å€¼:</p>
                                <p><code>next_node</code> - ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ç¼–å· (æ•´æ•°)</p>
                                <p><code>data</code> - ä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®</p>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 10px;">
                        <button class="btn btn-danger" onclick="deleteNode('${node.id}')">åˆ é™¤èŠ‚ç‚¹</button>
                        <button class="btn btn-primary" onclick="saveNode('${node.id}')">ä¿å­˜</button>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºç©ºç¼–è¾‘å™¨
        function showEmptyEditor() {
            const content = document.getElementById('editor-content');
            content.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ¯</div>
                    <div class="empty-state-text">é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹ç¼–è¾‘</div>
                    <div class="empty-state-hint">ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©èŠ‚ç‚¹ï¼Œæˆ–æ·»åŠ æ–°èŠ‚ç‚¹</div>
                    <div style="margin-top: 30px;">
                        <button class="btn btn-primary" onclick="showWorkflowSettings()" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border: none;
                            padding: 14px 28px;
                            border-radius: 10px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                        ">
                            âš™ï¸ å·¥ä½œæµè®¾ç½®
                        </button>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºå·¥ä½œæµè®¾ç½®
        async function showWorkflowSettings() {
            if (!currentWorkflow) {
                showToast('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©å·¥ä½œæµ', 'error');
                return;
            }

            const content = document.getElementById('editor-content');

            // è·å–å½“å‰å·¥ä½œæµçš„æ—¥å¿—è®¾ç½®
            const loggingEnabled = currentWorkflow.logging_enabled || false;

            content.innerHTML = `
                <div class="node-edit-form">
                    <div class="form-section">
                        <div class="form-section-title">âš™ï¸ å·¥ä½œæµè®¾ç½®</div>

                        <div style="margin-bottom: 30px;">
                            <h4 style="margin-bottom: 15px; color: #1a202c;">ğŸ“ åŸºæœ¬ä¿¡æ¯</h4>
                            <div class="form-field">
                                <label>å·¥ä½œæµåç§°</label>
                                <input type="text" id="setting-workflow-name" value="${currentWorkflow.name}" disabled style="opacity: 0.6;">
                            </div>
                            <div class="form-field">
                                <label>æè¿°</label>
                                <textarea id="setting-description" rows="2" placeholder="æè¿°è¿™ä¸ªå·¥ä½œæµçš„ä½œç”¨...">${currentWorkflow.description || ''}</textarea>
                            </div>
                        </div>

                        <div style="margin-bottom: 30px;">
                            <h4 style="margin-bottom: 15px; color: #1a202c;">ğŸ“Š æ‰§è¡Œæ—¥å¿—</h4>
                            <div class="form-field">
                                <label style="display: flex; align-items: center; gap: 12px;">
                                    <input type="checkbox" id="setting-logging-enabled" ${loggingEnabled ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;">
                                    <div>
                                        <strong style="display: block; margin-bottom: 4px;">å¯ç”¨æ‰§è¡Œæ—¥å¿—</strong>
                                        <div style="font-size: 13px; color: #718096;">
                                            è®°å½•æ¯æ¬¡æ‰§è¡Œçš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹æ‰§è¡Œç»“æœã€é”™è¯¯ä¿¡æ¯ç­‰
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div style="font-size: 12px; color: #718096; margin-top: 10px; padding: 10px; background: #f7fafc; border-radius: 8px;">
                                <strong>æ³¨æ„ï¼š</strong> å¯ç”¨æ—¥å¿—ä¼šè®°å½•æ¯æ¬¡æ‰§è¡Œçš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯èƒ½å½±å“æ€§èƒ½ï¼Œå»ºè®®ä»…åœ¨è°ƒè¯•æ—¶å¼€å¯ã€‚
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; color: #1a202c;">ğŸ“‹ æŸ¥çœ‹æ—¥å¿—</h4>
                            <button class="btn btn-primary" onclick="viewExecutionLogs()" style="width: 100%;">
                                ğŸ“œ æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—
                            </button>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #3a3a5c;">
                            <button class="btn" onclick="selectNode(null)">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="saveWorkflowSettings()">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ä¿å­˜å·¥ä½œæµè®¾ç½®
        async function saveWorkflowSettings() {
            if (!currentWorkflow) return;

            const data = {
                name: document.getElementById('setting-workflow-name').value,
                description: document.getElementById('setting-description').value,
                logging_enabled: document.getElementById('setting-logging-enabled').checked
            };

            try {
                await api(`/api/admin/workflows/${currentWorkflow.id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(data)
                });

                // æ›´æ–°æœ¬åœ°çŠ¶æ€
                currentWorkflow.logging_enabled = data.logging_enabled;

                showToast('ä¿å­˜æˆåŠŸ', 'å·¥ä½œæµè®¾ç½®å·²æ›´æ–°', 'success');
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥', error.message, 'error');
            }
        }

        // è·³è½¬åˆ°æ‰§è¡Œæ—¥å¿—é¡µé¢
        function viewExecutionLogs() {
            if (!currentWorkflow) {
                showToast('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©å·¥ä½œæµ', 'error');
                return;
            }
            window.location.href = `/ui/workflow-logs?workflow_id=${currentWorkflow.id}`;
        }

        // æ˜¾ç¤ºæ‰§è¡Œæ—¥å¿—ï¼ˆä¿ç•™ç”¨äºå…¶ä»–åœ°æ–¹çš„è°ƒç”¨ï¼‰
        async function showExecutionLogs() {
            if (!currentWorkflow) {
                showToast('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©å·¥ä½œæµ', 'error');
                return;
            }

            try {
                const response = await api(`/api/admin/workflows/${currentWorkflow.id}/logs?limit=50`);
                const logs = response.logs || [];

                if (logs.length === 0) {
                    showToast('æ— æ—¥å¿—', 'æš‚æ— æ‰§è¡Œæ—¥å¿—è®°å½•', 'info');
                    return;
                }

                // æ˜¾ç¤ºæ—¥å¿—å¯¹è¯æ¡†
                const logContent = logs.map(log => `
                    <div style="padding: 15px; border-bottom: 1px solid #e2e8f0; font-size: 13px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <strong style="color: #1a202c;">æ‰§è¡Œ #${log.execution_id ? log.execution_id.slice(0, 8) : 'Unknown'}</strong>
                            <span style="color: #${log.status === 'SUCCESS' ? '10b981' : 'ef4444'}; font-weight: 600;">
                                ${log.status === 'SUCCESS' ? 'âœ“ æˆåŠŸ' : 'âœ— å¤±è´¥'}
                            </span>
                        </div>
                        <div style="color: #718096; font-size: 12px; margin-bottom: 4px;">
                            æ—¶é—´: ${log.start_time || 'N/A'}
                            ${log.duration ? ` | è€—æ—¶: ${parseFloat(log.duration).toFixed(3)}ç§’` : ''}
                        </div>
                        <div style="margin-top: 8px;">
                            <button onclick="showLogDetail('${log.filename}')" style="
                                background: #f7fafc;
                                border: 1.5px solid #e2e8f0;
                                padding: 6px 12px;
                                border-radius: 6px;
                                font-size: 12px;
                                cursor: pointer;
                            ">æŸ¥çœ‹è¯¦æƒ…</button>
                        </div>
                    </div>
                `).join('');

                const detailContent = `
                    <div style="max-height: 500px; overflow-y: auto;">
                        <h4 style="margin-bottom: 15px;">ğŸ“‹ æ‰§è¡Œæ—¥å¿— (${logs.length}æ¡)</h4>
                        ${logContent}
                    </div>
                `;

                showToast('æ‰§è¡Œæ—¥å¿—', detailContent, 'info', 0);
            } catch (error) {
                showToast('é”™è¯¯', 'æ— æ³•åŠ è½½æ—¥å¿—: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ—¥å¿—è¯¦æƒ…
        async function showLogDetail(filename) {
            if (!currentWorkflow) return;

            try {
                const response = await api(`/api/admin/workflows/${currentWorkflow.id}/logs/${filename}`);
                const content = response.content || 'æ— æ³•è¯»å–æ—¥å¿—å†…å®¹';

                // å…³é—­ä¹‹å‰çš„å¯¹è¯æ¡†
                document.querySelectorAll('.toast').forEach(t => t.remove());

                // æ˜¾ç¤ºæ—¥å¿—å†…å®¹
                const detailContent = `
                    <div style="max-height: 600px; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0;">ğŸ“„ æ—¥å¿—è¯¦æƒ…</h4>
                            <button onclick="this.closest('.toast').remove()" style="
                                background: #f7fafc;
                                border: 1.5px solid #e2e8f0;
                                padding: 6px 12px;
                                border-radius: 6px;
                                font-size: 12px;
                                cursor: pointer;
                            ">å…³é—­</button>
                        </div>
                        <pre style="
                            background: #1a202c;
                            color: #e2e8f0;
                            padding: 15px;
                            border-radius: 8px;
                            font-size: 12px;
                            line-height: 1.6;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                            overflow-x: auto;
                        ">${content}</pre>
                    </div>
                `;

                showToast('æ—¥å¿—è¯¦æƒ…', detailContent, 'info', 0);
            } catch (error) {
                showToast('é”™è¯¯', 'æ— æ³•åŠ è½½æ—¥å¿—è¯¦æƒ…: ' + error.message, 'error');
            }
        }

        // ä¿å­˜èŠ‚ç‚¹
        function saveNode(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;

            node.name = document.getElementById('node-name').value;
            node.description = document.getElementById('node-description').value;
            node.code = document.getElementById('node-code').value;

            renderNodesList();
            showToast('ä¿å­˜æˆåŠŸ', 'èŠ‚ç‚¹å·²ä¿å­˜åˆ°å†…å­˜ä¸­', 'success');
        }

        // åˆ é™¤èŠ‚ç‚¹
        async function deleteNode(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            const confirmed = await showConfirm(
                'ç¡®è®¤åˆ é™¤èŠ‚ç‚¹',
                `ç¡®å®šè¦åˆ é™¤èŠ‚ç‚¹ "${node?.name || nodeId}" å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚`,
                null,
                {
                    icon: 'ğŸ—‘ï¸',
                    confirmText: 'ç¡®è®¤åˆ é™¤',
                    cancelText: 'å–æ¶ˆ'
                }
            );

            if (!confirmed) return;

            nodes = nodes.filter(n => n.id !== nodeId);
            selectedNodeId = null;
            renderNodesList();
            showEmptyEditor();
            updateStatus();

            showToast('åˆ é™¤æˆåŠŸ', 'èŠ‚ç‚¹å·²åˆ é™¤', 'success');
        }

        // å·¥ä½œæµæ“ä½œ
        async function loadWorkflowById(workflowId) {
            console.log('åŠ è½½å·¥ä½œæµ, workflowId:', workflowId);

            if (!workflowId) {
                showToast('é”™è¯¯', 'ç¼ºå°‘å·¥ä½œæµIDå‚æ•°', 'error');
                goBack();
                return;
            }

            try {
                console.log('æ­£åœ¨åŠ è½½å·¥ä½œæµè¯¦æƒ…...');
                const data = await api(`/api/admin/workflows/${workflowId}/detail`);
                console.log('APIè¿”å›æ•°æ®:', data);

                currentWorkflow = data.workflow;
                console.log('å½“å‰å·¥ä½œæµ:', currentWorkflow);

                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.getElementById('workflow-title').textContent = currentWorkflow.name;

                // è½¬æ¢èŠ‚ç‚¹æ•°æ®
                nodes = data.nodes.map(n => ({
                    id: n.id,
                    node_number: n.id.startsWith('node_') ? parseInt(n.id.split('_')[1]) : 1,
                    name: n.name,
                    code: n.config?.code || '',
                    description: n.config?.description || ''
                }));
                console.log('è½¬æ¢åçš„èŠ‚ç‚¹æ•°ç»„:', nodes);
                console.log('èŠ‚ç‚¹æ•°é‡:', nodes.length);

                // è®¡ç®—ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç¼–å·
                if (nodes.length > 0) {
                    nextNodeNumber = Math.max(...nodes.map(n => n.node_number)) + 1;
                } else {
                    nextNodeNumber = 1;
                }

                renderNodesList();
                updateStatus();
                updateWorkflowStatusButton();
            } catch (error) {
                console.error('åŠ è½½å·¥ä½œæµå¤±è´¥:', error);
                alert('åŠ è½½å·¥ä½œæµå¤±è´¥: ' + error.message);
            }
        }

        function clearWorkflow() {
            nodes = [];
            selectedNodeId = null;
            nextNodeNumber = 1;
            renderNodesList();
            showEmptyEditor();
            updateStatus();
            updateWorkflowStatusButton();
        }

        // åˆ‡æ¢å·¥ä½œæµå¯ç”¨çŠ¶æ€
        async function toggleWorkflowEnabled() {
            if (!currentWorkflow) {
                showToast('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©å·¥ä½œæµ', 'error');
                return;
            }

            const newEnabled = !currentWorkflow.enabled;

            try {
                await api(`/api/admin/workflows/${currentWorkflow.id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ enabled: newEnabled })
                });

                // æ›´æ–°æœ¬åœ°çŠ¶æ€
                currentWorkflow.enabled = newEnabled;

                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                updateWorkflowStatusButton();

                showToast(
                    'ä¿å­˜æˆåŠŸ',
                    `å·¥ä½œæµå·²${newEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`,
                    'success'
                );
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥', error.message, 'error');
            }
        }

        // æ›´æ–°å·¥ä½œæµçŠ¶æ€æŒ‰é’®
        function updateWorkflowStatusButton() {
            const icon = document.getElementById('workflow-status-icon');
            const text = document.getElementById('workflow-status-text');
            const btn = document.getElementById('toggle-workflow-btn');

            if (currentWorkflow && currentWorkflow.enabled) {
                icon.textContent = 'ğŸŸ¢';
                text.textContent = 'å·²å¯ç”¨';
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                btn.style.color = 'white';
            } else {
                icon.textContent = 'ğŸ”´';
                text.textContent = 'å·²ç¦ç”¨';
                btn.style.background = '';
                btn.style.color = '';
            }
        }

        async function saveWorkflow() {
            if (!currentWorkflow) {
                showToast('é”™è¯¯', 'è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºæµç¨‹', 'error');
                return;
            }

            // ä¿å­˜èŠ‚ç‚¹
            const workflowData = {
                nodes: nodes.map(n => ({
                    node_id: n.id,
                    node_type: 'python',
                    name: n.name,
                    position_x: n.node_number * 200,
                    position_y: 0,
                    config: {
                        code: n.code,
                        description: n.description
                    }
                })),
                connections: []
            };

            try {
                await api(`/api/admin/workflows/${currentWorkflow.id}/nodes`, {
                    method: 'POST',
                    body: JSON.stringify(workflowData)
                });
                showToast('ä¿å­˜æˆåŠŸ', `å·¥ä½œæµ "${currentWorkflow.name}" å·²ä¿å­˜ï¼Œå…± ${nodes.length} ä¸ªèŠ‚ç‚¹`, 'success');
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥', error.message, 'error');
            }
        }

        function updateStatus() {
            document.getElementById('status-nodes').textContent = nodes.length;
            document.getElementById('status-workflow').textContent = currentWorkflow ? currentWorkflow.name : 'æœªé€‰æ‹©';
        }

        function showHelp() {
            const helpContent = `
                <div style="line-height: 1.8; max-height: 500px; overflow-y: auto;">
                    <h4 style="margin-bottom: 15px;">ğŸ“– å·¥ä½œæµç¼–è¾‘å™¨å¸®åŠ©</h4>

                    <div style="margin-bottom: 20px;">
                        <strong style="color: #667eea;">ğŸ”€ ä½¿ç”¨æµç¨‹</strong>
                        <div style="margin-top: 8px; padding-left: 15px;">
                            1. ä»å·¥ä½œæµç®¡ç†é¡µé¢é€‰æ‹©è¦ç¼–è¾‘çš„å·¥ä½œæµ<br>
                            2. ç‚¹å‡»å·¦ä¸‹è§’"+"æŒ‰é’®æ·»åŠ æ–°çš„Pythonè„šæœ¬èŠ‚ç‚¹<br>
                            3. ç‚¹å‡»èŠ‚ç‚¹è¿›è¡Œç¼–è¾‘ï¼Œç¼–å†™Pythonä»£ç <br>
                            4. ç‚¹å‡»"ä¿å­˜"æŒ‰é’®å°†èŠ‚ç‚¹ä¿å­˜åˆ°æ•°æ®åº“
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <strong style="color: #667eea;">ğŸ“ èŠ‚ç‚¹è¿”å›å€¼</strong>
                        <div style="margin-top: 8px; padding-left: 15px; font-family: monospace; font-size: 13px;">
                            next_node = 0  # ç»“æŸæµç¨‹<br>
                            next_node = 2  # è·³è½¬åˆ°èŠ‚ç‚¹2<br>
                            result = data  # è¿”å›æ•°æ®
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <strong style="color: #667eea;">ğŸ¯ å¯ç”¨å˜é‡</strong>
                        <div style="margin-top: 8px; padding-left: 15px;">
                            â€¢ <code>request</code> - FastAPI Requestå¯¹è±¡<br>
                            â€¢ <code>data</code> - ä¸Šä¸€ä¸ªèŠ‚ç‚¹ä¼ é€’çš„æ•°æ®<br>
                            â€¢ <code>context</code> - {path, query, body, headers}
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <strong style="color: #48bb78;">ğŸ“š å¯ç”¨åº“ï¼ˆç›´æ¥importä½¿ç”¨ï¼‰</strong>
                        <div style="margin-top: 8px; padding: 15px; background: #f7fafc; border-radius: 8px; font-size: 12px; line-height: 1.6;">
                            <div><strong>å¸¸ç”¨æ ‡å‡†åº“:</strong></div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;">
                                <span>â€¢ os, sys</span>
                                <span>â€¢ json, re, base64</span>
                                <span>â€¢ datetime, time</span>
                                <span>â€¢ uuid, hashlib</span>
                                <span>â€¢ math, random</span>
                                <span>â€¢ pathlib (Path)</span>
                                <span>â€¢ collections</span>
                                <span>â€¢ itertools, functools</span>
                                <span>â€¢ typing</span>
                                <span>â€¢ copy, pickle</span>
                                <span>â€¢ decimal, fractions</span>
                                <span>â€¢ statistics</span>
                                <span>â€¢ string, textwrap</span>
                                <span>â€¢ urllib, html, xml</span>
                                <span>â€¢ sqlite3, logging</span>
                                <span>â€¢ dataclasses, enum</span>
                                <span>â€¢ numbers, ipaddress</span>
                            </div>
                            <div style="margin-top: 10px;"><strong>æç¤º:</strong> ä½¿ç”¨ <code>import åº“å</code> å¯¼å…¥ï¼Œå¦‚ <code>import os</code></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <strong style="color: #ed8936;">ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹</strong>
                        <div style="margin-top: 8px; padding: 15px; background: #1a202c; border-radius: 8px; font-size: 12px;">
                            <pre style="color: #e2e8f0; font-family: monospace; white-space: pre-wrap;"># å¯¼å…¥åº“å¹¶ä½¿ç”¨
import os
import json
from datetime import datetime
from pathlib import Path

# å¤„ç†æ•°æ®
data = {
    "user": context.get("body", {}).get("user", "è®¿å®¢"),
    "timestamp": datetime.now().isoformat(),
    "platform": os.name,
    "uuid": str(uuid.uuid4())
}

# è¿”å›
next_node = 0
result = data</pre>
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center;">
                        <button onclick="this.closest('.toast').remove()" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            padding: 12px 40px;
                            border-radius: 10px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                            å…³é—­å¸®åŠ©
                        </button>
                    </div>
                </div>
            `;
            showToast('ä½¿ç”¨å¸®åŠ©', helpContent, 'info', 0);
        }

        function goBack() {
            window.location.href = '/ui/workflows';
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
