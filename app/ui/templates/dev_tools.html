{% extends "base.html" %}

{% block content %}
<style>
.tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
}

.tool-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.export-area, .import-area {
    margin-top: 15px;
}

.textarea-large {
    width: 100%;
    height: 200px;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
    font-size: 13px;
    resize: vertical;
}

.btn-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 15px;
}

.status-item {
    background: #f7fafc;
    padding: 15px;
    border-radius: 8px;
}

.status-label {
    font-size: 12px;
    color: #718096;
    text-transform: uppercase;
    margin-bottom: 5px;
}

.status-value {
    font-size: 20px;
    font-weight: 700;
    color: #2d3748;
}

.status-value.success { color: #10b981; }
.status-value.warning { color: #f59e0b; }
.status-value.error { color: #ef4444; }

.file-list {
    max-height: 300px;
    overflow-y: auto;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: #f7fafc;
    border-radius: 6px;
    margin-bottom: 8px;
}

.file-info {
    flex: 1;
}

.file-name {
    font-weight: 600;
    color: #2d3748;
}

.file-size {
    font-size: 12px;
    color: #718096;
}

.drop-zone {
    border: 2px dashed #cbd5e0;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.drop-zone:hover, .drop-zone.dragover {
    border-color: #667eea;
    background: #f7fafc;
}
</style>

<div class="card">
    <h2>ğŸ› ï¸ å¼€å‘è€…å·¥å…·</h2>
    <p style="color: #718096; margin-top: 5px;">å·¥ä½œæµå¯¼å…¥å¯¼å‡ºã€ç³»ç»ŸçŠ¶æ€ç›‘æ§ã€å­˜å‚¨ç®¡ç†</p>
</div>

<div class="tools-grid">
    <!-- å·¥ä½œæµå¯¼å‡º -->
    <div class="tool-card">
        <h3 style="margin-top: 0;">ğŸ“¤ å·¥ä½œæµå¯¼å‡º</h3>
        <p style="color: #718096; font-size: 14px;">å°†å·¥ä½œæµå¯¼å‡ºä¸º JSON æ ¼å¼ï¼Œæ–¹ä¾¿å¤‡ä»½å’Œè¿ç§»</p>

        <div style="margin-top: 15px;">
            <label style="font-weight: 600; font-size: 13px; color: #4a5568;">é€‰æ‹©å·¥ä½œæµ</label>
            <select id="export-workflow" class="form-input" style="width: 100%; margin-top: 5px;">
                <option value="">-- é€‰æ‹©å·¥ä½œæµ --</option>
            </select>
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" onclick="exportWorkflow()">å¯¼å‡º JSON</button>
            <button class="btn" onclick="copyExport()">å¤åˆ¶</button>
        </div>

        <div class="export-area">
            <textarea id="export-result" class="textarea-large" readonly placeholder="å¯¼å‡ºçš„å·¥ä½œæµ JSON å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        </div>
    </div>

    <!-- å·¥ä½œæµå¯¼å…¥ -->
    <div class="tool-card">
        <h3 style="margin-top: 0;">ğŸ“¥ å·¥ä½œæµå¯¼å…¥</h3>
        <p style="color: #718096; font-size: 14px;">ä» JSON å¯¼å…¥å·¥ä½œæµé…ç½®</p>

        <div class="import-area">
            <textarea id="import-data" class="textarea-large" placeholder='ç²˜è´´å·¥ä½œæµ JSONï¼Œæ ¼å¼ï¼š
{
  "workflow": {"name": "...", "description": "..."},
  "nodes": [...],
  "connections": [...]
}'></textarea>
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" onclick="importWorkflow()">å¯¼å…¥å·¥ä½œæµ</button>
            <button class="btn" onclick="clearImport()">æ¸…ç©º</button>
        </div>

        <div id="import-result" style="margin-top: 15px;"></div>
    </div>
</div>

<div class="tools-grid" style="margin-top: 20px;">
    <!-- ç³»ç»ŸçŠ¶æ€ -->
    <div class="tool-card">
        <h3 style="margin-top: 0;">ğŸ’» ç³»ç»ŸçŠ¶æ€</h3>
        <p style="color: #718096; font-size: 14px;">æŸ¥çœ‹ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯</p>

        <div class="status-grid" id="system-status">
            <div class="status-item">
                <div class="status-label">æ€»è¯·æ±‚æ•°</div>
                <div class="status-value" id="stat-requests">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">æˆåŠŸç‡</div>
                <div class="status-value" id="stat-success">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">å¹³å‡å“åº”</div>
                <div class="status-value" id="stat-latency">-<span style="font-size: 14px;">ms</span></div>
            </div>
            <div class="status-item">
                <div class="status-label">å·¥ä½œæµæ•°é‡</div>
                <div class="status-value" id="stat-workflows">-</div>
            </div>
        </div>

        <button class="btn" style="width: 100%; margin-top: 15px;" onclick="loadSystemStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
    </div>

    <!-- å­˜å‚¨ç®¡ç† -->
    <div class="tool-card">
        <h3 style="margin-top: 0;">ğŸ“ å­˜å‚¨ç®¡ç†</h3>
        <p style="color: #718096; font-size: 14px;">æŸ¥çœ‹å’Œç®¡ç†å­˜å‚¨æ–‡ä»¶</p>

        <div class="file-list" id="storage-files">
            <div style="text-align: center; padding: 20px; color: #a0aec0;">åŠ è½½ä¸­...</div>
        </div>

        <div class="btn-group">
            <button class="btn" onclick="loadStorageFiles()">ğŸ”„ åˆ·æ–°</button>
            <button class="btn" onclick="openStorageFolder()" style="background: #f7fafc;">ğŸ“‚ æ‰“å¼€æ–‡ä»¶å¤¹</button>
        </div>
    </div>
</div>

<script>
// ========== å·¥ä½œæµå¯¼å‡º ==========

async function loadWorkflows() {
    const select = document.getElementById('export-workflow');
    try {
        const response = await fetch('/api/admin/workflows');
        const data = await response.json();

        select.innerHTML = '<option value="">-- é€‰æ‹©å·¥ä½œæµ --</option>';
        data.items.forEach(wf => {
            const option = document.createElement('option');
            option.value = wf.id;
            option.textContent = wf.name + (wf.description ? ` (${wf.description})` : '');
            select.appendChild(option);
        });
    } catch (error) {
        showToast('åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½å·¥ä½œæµåˆ—è¡¨', 'error');
    }
}

async function exportWorkflow() {
    const workflowId = document.getElementById('export-workflow').value;
    if (!workflowId) {
        showToast('è¯·é€‰æ‹©å·¥ä½œæµ', 'è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„å·¥ä½œæµ', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/admin/workflows/${workflowId}/export`);
        const data = await response.json();

        document.getElementById('export-result').value = JSON.stringify(data, null, 2);
        showToast('å¯¼å‡ºæˆåŠŸ', 'å·¥ä½œæµå·²å¯¼å‡ºä¸º JSON', 'success');
    } catch (error) {
        showToast('å¯¼å‡ºå¤±è´¥', error.message, 'error');
    }
}

function copyExport() {
    const textarea = document.getElementById('export-result');
    if (!textarea.value) {
        showToast('æ²¡æœ‰å†…å®¹', 'è¯·å…ˆå¯¼å‡ºå·¥ä½œæµ', 'error');
        return;
    }

    textarea.select();
    document.execCommand('copy');
    showToast('å¤åˆ¶æˆåŠŸ', 'JSON å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
}

// ========== å·¥ä½œæµå¯¼å…¥ ==========

async function importWorkflow() {
    const data = document.getElementById('import-data').value;
    if (!data.trim()) {
        showToast('è¯·è¾“å…¥æ•°æ®', 'è¯·ç²˜è´´å·¥ä½œæµ JSON', 'error');
        return;
    }

    try {
        const jsonData = JSON.parse(data);

        const response = await fetch('/api/admin/workflows/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(jsonData)
        });

        const result = await response.json();

        if (response.ok) {
            document.getElementById('import-result').innerHTML = `
                <div style="padding: 12px; background: #d1fae5; border-radius: 6px; color: #065f46;">
                    âœ… ${result.message}<br>
                    <strong>å·¥ä½œæµID:</strong> ${result.workflow.id}<br>
                    <strong>åç§°:</strong> ${result.workflow.name}
                </div>
            `;
            showToast('å¯¼å…¥æˆåŠŸ', `å·¥ä½œæµ "${result.workflow.name}" å·²åˆ›å»º`, 'success');
            loadWorkflows(); // åˆ·æ–°åˆ—è¡¨
        } else {
            throw new Error(result.detail || 'å¯¼å…¥å¤±è´¥');
        }
    } catch (error) {
        document.getElementById('import-result').innerHTML = `
            <div style="padding: 12px; background: #fee2e2; border-radius: 6px; color: #991b1b;">
                âŒ ${error.message}
            </div>
        `;
        showToast('å¯¼å…¥å¤±è´¥', error.message, 'error');
    }
}

function clearImport() {
    document.getElementById('import-data').value = '';
    document.getElementById('import-result').innerHTML = '';
}

// ========== ç³»ç»ŸçŠ¶æ€ ==========

async function loadSystemStatus() {
    try {
        // è¯·æ±‚ç»Ÿè®¡
        const statsRes = await fetch('/api/dev/request-stats');
        const stats = await statsRes.json();

        document.getElementById('stat-requests').textContent = stats.total_requests;
        document.getElementById('stat-success').textContent = stats.success_rate + '%';
        document.getElementById('stat-latency').innerHTML = stats.avg_duration_ms + '<span style="font-size: 14px;">ms</span>';

        // å·¥ä½œæµæ•°é‡
        const wfRes = await fetch('/api/admin/workflows');
        const wfData = await wfRes.json();
        document.getElementById('stat-workflows').textContent = wfData.items.length;

    } catch (error) {
        console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', error);
    }
}

// ========== å­˜å‚¨ç®¡ç† ==========

async function loadStorageFiles() {
    try {
        const response = await fetch('/api/dev/storage-files');
        const data = await response.json();

        const container = document.getElementById('storage-files');

        if (!data.files || data.files.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #a0aec0;">æš‚æ— æ–‡ä»¶</div>';
            return;
        }

        container.innerHTML = data.files.map(file => `
            <div class="file-item">
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${formatSize(file.size)} â€¢ ${file.modified}</div>
                </div>
                <button class="btn btn-sm" onclick="deleteFile('${file.path}')" style="background: #fee2e2; color: #991b1b;">åˆ é™¤</button>
            </div>
        `).join('');
    } catch (error) {
        document.getElementById('storage-files').innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">åŠ è½½å¤±è´¥</div>';
    }
}

function openStorageFolder() {
    // åœ¨æ–°çª—å£æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨
    alert('å­˜å‚¨ç›®å½•: ./storage/\n\nè¯·æ‰‹åŠ¨æ‰“å¼€æ­¤ç›®å½•æŸ¥çœ‹æ–‡ä»¶');
}

async function deleteFile(path) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å—ï¼Ÿ\n${path}`)) return;

    try {
        await fetch('/api/dev/storage-files', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path })
        });
        showToast('åˆ é™¤æˆåŠŸ', 'æ–‡ä»¶å·²åˆ é™¤', 'success');
        loadStorageFiles();
    } catch (error) {
        showToast('åˆ é™¤å¤±è´¥', error.message, 'error');
    }
}

function formatSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// åˆå§‹åŒ–
loadWorkflows();
loadSystemStatus();
loadStorageFiles();
</script>
{% endblock %}
